<script >

    window.onscroll = function() {
        scrollFunction()
    };
getNotesGlobal();

function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        document.getElementById("myBtn").style.display = "block";
    } else {
        document.getElementById("myBtn").style.display = "none";
    }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}

$('#save_sheet_btn').on('click', function(e) {
    var id = $('#mysheet').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(stockCheck).QTYInport(id);

});

$('#save_sheet_btn2').on('click', function(e) {
    var id = $('#mysheet2').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).createRefferenceDB(id);

});

$('#save_sheet_btn3').on('click', function(e) {
    var id = $('#mysheet3').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importRecipesFromSheet(id);

});
$('#save_sheet_btn4').on('click', function(e) {
    var id = $('#mysheet4').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importBoxesFromSheet(id);

});
$('#save_sheet_btn5').on('click', function(e) {
    var id = $('#mysheet5').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importPackagesFromSheet(id);

});

$('#save_sheet_btn6').on('click', function(e) {
    var id = $('#mysheet6').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importCustomersFromSheet(id);

});

$('#save_sheet_btn7').on('click', function(e) {
    var id = $('#mysheet7').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importBrandsFromSheet(id);

});

$('#save_sheet_btn8').on('click', function(e) {
    var id = $('#mysheet8').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importFlavoursFromSheet(id);

});

$('#save_sheet_btn9').on('click', function(e) {
    var id = $('#mysheet9').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importBottlesFromSheet(id);

});

$('#save_sheet_btn10').on('click', function(e) {
    var id = $('#mysheet10').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importLidsFromSheet(id);

});

$('#save_sheet_btn11').on('click', function(e) {
    var id = $('#mysheet11').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importLabelsFromSheet(id);

});
$('#save_sheet_btn12').on('click', function(e) {
    var id = $('#mysheet12').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importColorsFromSheet(id);

});
$('#save_sheet_btn13').on('click', function(e) {
    var id = $('#mysheet13').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(checkProccessStatus).importBlankPCPC2(id);

});

$('#save_sheet_btn14').on('click', function(e) {
    var id = $('#mysheet14').val();
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).importInventoryData(id);

});

function save(msg) {
    msg = msg.replace(/<br\/?>/gi, '\n');
    $("#updating").css("display", "none");

    alert(msg);

}

$('#savepoint').on('click', function(e) {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(save).savePoint();

});

$('#restorepoint').on('click', function(e) {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(restore).restorePoint();

});

function restore() {
    alert('Restored. Please refresh the page.');
}
var thisData;
var thisPage;

function deleteAll() {
    var ms = "WARNING! You are about to delete all displayed orders. \n Are you sure?";
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(exportSuccess).deleteAll(thisData, thisPage);

    }

}

var SelAllOrders;

function selectAll() {
    for (var i = 0; i < SelAllOrders.length; i++) {

        addToSelected(SelAllOrders[i].batch);

    }

}
var exportArr = [];
$('.form-check-input').change(function(e) {
    var page = $(this).attr('page');
    if (page == 'ALLPAGES') {
        $(".form-check-input").prop('checked', $(this).prop('checked'));
    }
});

$('#subExportForm').on('click', function(e) {
    var checkboxes = document.getElementsByName('expCheckbox');
    var checkboxesChecked = [];
    // loop over them all
    for (var i = 0; i < checkboxes.length; i++) {
        // And stick the checked ones onto an array...
        if (checkboxes[i].checked) {
            checkboxesChecked.push(checkboxes[i].getAttribute("page"));
        }
    }
    console.log(checkboxesChecked);
    google.script.run.withSuccessHandler(exportSuccess).export(checkboxesChecked);
});

function exportSuccess(msg) {
    $("#updating").css("display", "none");
    alert(msg);
    $('#funcBody').html(msg);
}

//SUB TABS

$("#notRunDiv").click(function() {

    $(".panelItem").css("background-color", "#f4f7f8");
    $(".panelItem").css("color", "black");

    $("#notRunDiv").css("background-color", "#195685");
    $("#notRunDiv").css("color", "#FFF");

    filterpage();
});

//THREE SUB TABS
var BASEPARAM = {
    orderBy: 'final_status',
    equalTo: 'Not Run'

};

function getBaseSearchParam(event) {

    var param = $(event).attr('param');

    BASEPARAM.equalTo = param;

}

var ACTIVETABS = ['Orders', 'FlavourMixOrders', 'Mixing', 'MixingTeam', 'FlavourMixMixingTeam', 'PremixColoring', 'Production', 'Printing', 'Labelling', 'Packaging'];

function hideDiv() {
    if (selPage == 'Orders') {
        $("#wentNegative").show();
        $("#ordersSubTab").show();

    } else if (selPage == 'FlavourMixOrders') {
        $("#ordersSubTab").show();

    } else {
        $("#wentNegative").hide();
        $("#ordersSubTab").hide();

    }
    console.log('selPage', selPage);
    if (ACTIVETABS.indexOf(selPage) == -1) {
        $("#baseFilters").hide();
    } else {
        $("#baseFilters").show();
    }

}
var SEARCHNUM = 0;
//Form
getSearchBoxData('Orders');
thisPage = 'Orders';
var qtySheet = "#Misc";
//Tabs
var subtabChange = false;
var app = 'Admin';
//   populateOrdersTab();
var selPage = 'Orders';
google.script.run.withSuccessHandler(logSuccess).logUser(selPage, app);
filterpage('xx', true);

$('.tabs .tab-links a').on('click', function(e) {
    $("#subTabFlavourMixOrders").removeClass('active');
    $('.content').html('');
    $('.modal-body').html('');
    var subtab = $(this).attr('sub');
    pagesSplit = false;
    $("#scheduleOptions").hide();
    if (subtab == 'sub') {

        $(this).parent('li').addClass('active').siblings().removeClass('active');

        if ($(this).attr('id') == 'scheduled') {
            $("#scheduleOptions").show();

            google.script.run.withSuccessHandler(setScheduleDropdown).getScheduleDropdown();

        } else {

            var param = $(this).attr('param');
            BASEPARAM.equalTo = param;
            filterpage('xx', true);

        }
    } else if (subtab == 'subOrder') {

        var page = $(this).attr('page');
        thisPage = page;
        selPage = page;
        filterpage('xx', true);
        $("#subTabFlavourMixOrders").addClass('active');
    } else {

        var currentAttrValue = $(this).attr('href');

        // Show/Hide Tabs
        $('.tabs ' + currentAttrValue).show().siblings().hide();
        $(this).parent('li').addClass('active').siblings().removeClass('active');

        populateSheet(currentAttrValue);
        // Change/remove current tab to active

    }
    hideDiv();
    e.preventDefault();
    e.stopPropagation();

});

var activetab = '#tab1';

function populateSheet(current) {
    activetab = current;
    if (current == '#tab1') {
        //    populateOrdersTab();
        getSearchBoxData('Orders');
        SELECTED = [];
        selPage = 'Orders';

        displaySelected(SELECTED);

    } else if (current == '#tab2') {
        //  populateMixingTab();
        selPage = 'Mixing';
        // getSearchBoxData('Mixing');
    } else if (current == '#tab3') {
        // populateProductionTab();
        SELECTED = [];
        selPage = 'Production';
        displaySelected(SELECTED);
        getSearchBoxData('Production');
    } else if (current == '#tab4') {
        // populatePrintingTab();
        selPage = 'Printing';
        getSearchBoxData('Printing');
    } else if (current == '#tab5') {
        // populateLabellingTab();
        selPage = 'Labelling';
        getSearchBoxData('Labelling');
    } else if (current == '#tab6') {
        // populatePackagingTab();
        SELECTED = [];
        selPage = 'Packaging';
        displaySelected(SELECTED);
        getSearchBoxData('Packaging');
    } else if (current == '#tab7') {
        selPage = 'Shipping';
        //populateShippingTab();
        getSearchBoxData('Shipping');

    } else if (current == '#tab8') {
        populateLocationsTab();
        selPage = 'Locations';
    } else if (current == '#tab9') {
        populateQTYTab(qtySheet.substr(1, qtySheet.length));
        selPage = 'QTY';
        //google.script.run.withSuccessHandler(splitPages).getQTY('Misc');
    } else if (current == '#tab10') {

        selPage = 'Inventory';
        // populateInventoryTab();
        getSearchBoxData('Inventory');
    } else if (current == '#tab11') {

        selPage = 'Finctions';
    } else if (current == '#tab12') {
        google.script.run.withSuccessHandler(setupReporting).getReportingData();
        selPage = 'Reporting';
    }
    hideDiv();
    google.script.run.withSuccessHandler(logSuccess).logUser(selPage, app);
    filterpage('xx', true);

}
//Tabs2

function logSuccess() {
    console.log('User Logged.');
}
//Tabs

$('.tabs2 .tab-links2 a').on('click', function(e) {

    var currentAttrValue2 = $(this).attr('href');
    qtySheet = currentAttrValue2;
    // Show/Hide Tabs
    //  $('.tabs2 ' + currentAttrValue).show().siblings().hide();
    $(this).parent('li').addClass('active').siblings().removeClass('active');
    e.preventDefault();

    e.stopPropagation();
    console.log(qtySheet);
    populateQTYTab(qtySheet.substr(1, qtySheet.length));
    // Change/remove current tab to active

});

//Tabs
var MixSheet = "#Mixing";
$('.tabs3 .tab-links3 a').on('click', function(e) {

    var currentAttrValue3 = $(this).attr('href');
    MixSheet = currentAttrValue3;
    // Show/Hide Tabs
    //  $('.tabs2 ' + currentAttrValue).show().siblings().hide();
    $(this).parent('li').addClass('active').siblings().removeClass('active');
    e.preventDefault();
    e.stopPropagation();
    console.log(currentAttrValue3);
    if (currentAttrValue3 == '#Mixing') {
        selPage = 'Mixing';
        filterpage('xx', true);
        //  populateMixingTab();

    } else if (currentAttrValue3 == '#MixingTeam') {

        selPage = 'MixingTeam';
        filterpage('xx', true);

    } else if (currentAttrValue3 == '#FlavourMixMixingTeam') {

        selPage = 'FlavourMixMixingTeam';
        filterpage('xx', true);
        //  populateMixingTeamTab();
    } else if (currentAttrValue3 == '#PremixColoring') {

        selPage = 'PremixColoring';
        filterpage('xx', true);
        //  populateMixingTeamTab();
    }

    // Change/remove current tab to active

});


$('#newOrder').on('click', function(e) {
    $('.modal-body').html('');
    
    EDITORDER = false;
    google.script.run.withSuccessHandler(buildForm).getFormData('');
});
$('#neworder').on('click', function(e) {
    $('.modal-body').html('');
    
    EDITORDER = false;
    google.script.run.withSuccessHandler(buildForm).getFormData('');
});
$('#newOrderStock').on('click', function(e) {
    $('.modal-body').html('');
    
    EDITORDER = false;
    google.script.run.withSuccessHandler(buildFormStock).getFormData('B');
});
function clearLastPage() {
    var inmix = thisPage.match('Mixing');
    if (inmix != -1) {
        $('#Mixing').html('');
    } else if (thisPage == 'Orders') {
        $('#pageBody').html('');
    } else {
        $('#' + thisPage).html('');
    }
    console.log('Cleared ' + thisPage)

}

function pcselect() {
    var PC = $("#PCSelect").val();
    console.log('changed');
    console.log('PC');
    google.script.run.withSuccessHandler(repopFORM).getPCSelect(PC);
}

function pdselect() {
    var PC = $("#PDDSelect option:selected").attr('key');
    console.log(PC);
    google.script.run.withSuccessHandler(repopFORM).getPCSelect(PC);
}

function repopFORM(data) {
    console.log(data);
    $("#PCSelect").val(data.prod);
    $("#PDDSelect").val(data.descr);
    $("#brandSelect").val(data.brandSKU);
    $("#bottleType").val(data.botSKU);
     $("#tubeType").val(data.tubeSKU);
     $("#usecomb").prop('checked',data.usecomb);
    $("#lidType").val(data.lidSKU);
    $("#packagingType").val(data.packagingType.sku);

    $("#updating").hide();

}
var edit_flavour_mix_order = false;
var STOCKORDER = false;
function buildForm(data) {
    console.log(data);
     STOCKORDER = false;
    $('#subModalForm').show(); 
    var html = '';

    html += '<table class="form_table">';
    html += '<tr><td><h4>Order Date</h4></td><td><h4>Batch</h4></td><td><h4>Code</h4></td><td><h4>Description</h4></td><td><h4>OrderID</h4></td></tr>';
    html += '<tr><td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch" aria-describedby="sizing-addon2"></div></td>';
    var codeSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.PC.length; i++) {
        codeSelect += '<option value="' + data.PC[i].prod + '" id="' + data.PC[i].prod + '">' + data.PC[i].productcode + '<option>';
    }
    html += '<td><select class="form-control" onchange="pcselect();" id="PCSelect">' + codeSelect + '</select></td>';

    var descSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.PD.length; i++) {
        descSelect += '<option value="' + data.PD[i].descr + '" id="' + data.PD[i].descr + '"  key="' + data.PD[i].prod + '">' + data.PD[i].productdescription + '<option>';
    }
    html += '<td><select class="form-control" onchange="pdselect();" id="PDDSelect">' + descSelect + '</select></td>';

    html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderID"  class="form-control" placeholder="OrderID" aria-describedby="sizing-addon2"></div></td>';
    var customerSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.customers.length; i++) {
        customerSelect += '<option value="' + data.customers[i].sku + '" id="' + data.customers[i].name + '">' + data.customers[i].name + '<option>';
    }

    var brandSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.brands.length; i++) {
        brandSelect += '<option value="' + data.brands[i].sku + '" id="' + data.brands[i].name + '">' + data.brands[i].name + '<option>';
    }
    html += '</tr>';

    html += '<tr><td><h4>Customer</h4></td><td><h4>Brand</h4></td><td><h4>Packs for customer</h4></td></tr>';
    html += '<tr><td><select class="form-control" id="customerSelect">' + customerSelect + '</select></td><td><select class="form-control"  id="brandSelect">' + brandSelect + '</select></td>';

    html += '<td><div class="input-group"><input type="text" id="numBottles" class="form-control" placeholder="Packs for customer" aria-describedby="sizing-addon2"></div></td>';

    
    html += '</tr>';

    html += '<tr></td><td><h4>Bottle Type</h4></td><td><h4>Tube Type</h4></td><td><h4>Lid Type</h4></td>';
    html += '<td><h4>Pack Type</h4></td></tr>';
    html += '<tr>';
    var bottleSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        bottleSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].name + '">' + data.bottletypes[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="bottleType">' + bottleSelect + '</select></td>';
    var tubeSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        tubeSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].name + '">' + data.bottletypes[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="tubeType">' + tubeSelect + '</select></td>';

    var lidSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.lids.length; i++) {
        lidSelect += '<option value="' + data.lids[i].sku + '" >' + data.lids[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="lidType">' + lidSelect + '</select></td>';

    var packagingSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.packagings.length; i++) {
        packagingSelect += '<option value="' + data.packagings[i].sku + '" id="' + data.packagings[i].sku + '">' + data.packagings[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="packagingType">' + packagingSelect + '</select></td>';

    html += '</tr></table>';
     
       

    $("#updating").hide();
    $('.modal-body').html(html);
     $("#orderbatch").val(data.batch);
}


function buildFormStock(data) {
    STOCKORDER = true;
    console.log(data);
    $('#subModalForm').show(); 
 
    var html = '';

    html += '<table class="form_table">';
    html += '<tr><td><h4>Order Date</h4></td><td><h4>Batch</h4></td><td><h4>Code</h4></td><td><h4>Description</h4></td><td><h4>OrderID</h4></td></tr>';
    html += '<tr><td><div class="input-group"><input type="date" value=""  name="orderDate"  id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderbatch"  class="form-control" placeholder="Batch"  value="'+data.batch+'" aria-describedby="sizing-addon2"></div></td>';
    var codeSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.PC.length; i++) {
        codeSelect += '<option value="' + data.PC[i].prod + '" id="' + data.PC[i].prod + '">' + data.PC[i].productcode + '<option>';
    }
    html += '<td><select class="form-control" onchange="pcselect();" id="PCSelect">' + codeSelect + '</select></td>';

    var descSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.PD.length; i++) {
        descSelect += '<option value="' + data.PD[i].descr + '" id="' + data.PD[i].descr + '"  key="' + data.PD[i].prod + '">' + data.PD[i].productdescription + '<option>';
    }
    html += '<td><select class="form-control" onchange="pdselect();" id="PDDSelect">' + descSelect + '</select></td>';

    html += '<td><div class="input-group"><input type="text" value="" name="orderbatch" id="orderID"  class="form-control" placeholder="OrderID" aria-describedby="sizing-addon2"></div></td>';
    var customerSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.customers.length; i++) {
        customerSelect += '<option value="' + data.customers[i].sku + '" id="' + data.customers[i].name + '">' + data.customers[i].name + '<option>';
    }

    var brandSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.brands.length; i++) {
        brandSelect += '<option value="' + data.brands[i].sku + '" id="' + data.brands[i].name + '">' + data.brands[i].name + '<option>';
    }
    html += '</tr>';

    html += '<tr><td><h4>Customer</h4></td><td><h4>Brand</h4></td><td><h4>Bottles</h4></td><td><h4>Use Comb</h4></td></tr>';
    html += '<tr><td><select class="form-control" id="customerSelect">' + customerSelect + '</select></td><td><select class="form-control"  id="brandSelect">' + brandSelect + '</select></td>';

    html += '<td><div class="input-group"><input type="text" id="numBottles" class="form-control" placeholder="Bottles" aria-describedby="sizing-addon2"></div></td>';

    html += '<td>	<div class="form-check"><input type="checkbox"  id="usecomb"/></div></td>';


    html += '</tr>';

    html += '<tr></td><td><h4>Bottle Type</h4></td><td><h4>Tube Type</h4></td><td><h4>Lid Type</h4></td>';
    html += '<td><h4>Pack Type</h4></td><td><h4>Serum Batch Code</h4></td><td><h4>Stimulant Batch Code</h4></td></tr>';
    html += '<tr>';
    var bottleSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        bottleSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].name + '">' + data.bottletypes[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="bottleType">' + bottleSelect + '</select></td>';
    var tubeSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        tubeSelect += '<option value="' + data.bottletypes[i].sku + '" id="' + data.bottletypes[i].name + '">' + data.bottletypes[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="tubeType">' + tubeSelect + '</select></td>';

    var lidSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.lids.length; i++) {
        lidSelect += '<option value="' + data.lids[i].sku + '" >' + data.lids[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="lidType">' + lidSelect + '</select></td>';

    var packagingSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.packagings.length; i++) {
        packagingSelect += '<option value="' + data.packagings[i].sku + '" id="' + data.packagings[i].sku + '">' + data.packagings[i].name + '<option>';
    }
    html += '<td><select class="form-control" id="packagingType">' + packagingSelect + '</select></td>';
    html += '<td><div class="input-group"><input type="text" id="serumBatchCode" class="form-control" placeholder="Serum Batch Codes" aria-describedby="sizing-addon2"></div></td>';

    html += '<td><div class="input-group"><input type="text" id="stimulantBatchCode" class="form-control" placeholder="Stimulant Batch Codes" aria-describedby="sizing-addon2"></div></td>';

    html += '</tr></table>';


    $("#updating").hide();
    $('.modal-body').html(html);
  $("#orderbatch").val(data.batch);
}

$('#subModalForm').on('click', function(e) {
    var productcode = $('#PCSelect').val();
    console.log('selected Code: ' + productcode);
    var productdescription = $('#PDDSelect').val();
    console.log('selected desc: ' + productdescription);

    if (productcode.length > 20) {
        var t = productcode;
        productcode = productdescription;
        productdescription = t;
    }
    var orderID = $('#orderID').val();
    var date = $('#orderDate').val();
    var batch = $('#orderbatch').val();
    console.log(batch);
    var priority = $('#priority').val();
    var serumBatchCode = $('#serumBatchCode').val();
    var stimulantBatchCode = $('#stimulantBatchCode').val();
    var customerSKU = $('#customerSelect').val();
    var customerSelect = $('#customerSelect option:selected').text();

    var brandSKU = $('#brandSelect').val();
    var brandSelect = $('#brandSelect option:selected').text();

    var batch = $('#batch').val();
    var priority = $('#priority').val();

    var numBottles = $('#numBottles').val();
    numBottles = parseInt(numBottles, 10);

    var botSKU = $('#bottleType').val();
    var bottleType = $('#bottleType option:selected').text();

    var tubeSKU = $('#tubeType').val();
    var tubeType = $('#tubeType option:selected').text();

    var lidSKU = $('#lidType').val();
    var lidType = $('#lidType option:selected').text();

    var packagingTypesku = $('#packagingType').val();
    var packagingTypename = $('#packagingType option:selected').text();

    var object = {
        batch: $('#orderbatch').val(),
        productcode: productcode,
        productdescription: productdescription,
        orderdate: date,
        serumBatchCode: serumBatchCode,
        stimulantBatchCode: stimulantBatchCode,
        priority: priority,
        customer: customerSelect,
        brand: brandSelect,
        brandSKU: brandSKU,
        bottles: numBottles,
        btype: bottleType,
        lid: lidType,
        lidSKU: lidSKU,
        botSKU: botSKU,
        tubeSKU: tubeSKU,
        tubeType: tubeType,
        customerSKU: customerSKU,
        brandSKU: brandSKU,

        packagingType: {
            sku: '',
            name: '',

        },
        orderID: orderID,
        ppp: $('#prePrintedPackLabels').is(":checked"),
        ppb: $('#prePrintedBottleLabels').is(":checked"),
        usecomb: $('#usecomb').is(":checked"),
        combs: numBottles,
    };

    object.packagingType.sku = packagingTypesku;
    object.packagingType.name = packagingTypename;

    console.log(object);
    google.script.run.withSuccessHandler(newOrderSuccess).saveOrder(object, EDITORDER);

});

function newOrderSuccess(e) {
    filterpage('xx', true);
    //   google.script.run.withSuccessHandler(buildOrders).getOrdersData();
    alert(e);

}

function populateOrdersTab() {
    filterpage('xx', true);
    //  google.script.run.withSuccessHandler(buildOrders).getOrdersData();

}

function formatDateDisplay(datems) {
    try {
        if (datems && datems != "") {
            var now = new Date(datems);

            var day = ("0" + now.getDate()).slice(-2);
            var month = ("0" + (now.getMonth() + 1)).slice(-2);

            var today = (day) + "-" + (month) + "-" + now.getFullYear();

            return today;
        } else {
            return '';
        }
    } catch (e) {
        console.log('Unable to format date: ', datems);
        return '';
    }
}

function formatDateDisplay2(datems) {
    try {
        if (datems && datems != "") {
            var num = parseInt(datems, 10);
            if (num < 5000) {
                var now = new Date(datems);
            } else {
                var now = new Date(num);
            }
            var now1 = now.toISOString().replace('T', ' ').replace('Z', '').split('.');

            var now2 = now1[0].split(' ');

            var now3 = now2[0].split('-');
            var now4 = now3[2] + '-' + now3[1] + '-' + now3[0] + ' ' + now2[1];

            return now4;

        } else {
            return '';
        }
    } catch (e) {
        console.log('Unable to format date: ', datems);
        return '';
    }
}

function formatDateInput(datems) {
    try {
        var now = new Date(datems);

        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);

        var today = now.getFullYear() + "-" + (month) + "-" + (day);
        return today;
    } catch (e) {
        console.log('Unable to format date: ', datems);
        var now = new Date();

        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);

        var today = now.getFullYear() + "-" + (month) + "-" + (day);
        return today;

    }
}

function buildOrders(data) {
    var machinesHTML = '<option></option>';
    google.script.run.withSuccessHandler(buildMachinesOptions).getMachines();

    function buildMachinesOptions(rett) {
        var machines = rett[0];

        for (var i = 0; i < machines.length; i++) {
            machinesHTML += '<option sku="' + machines[i].sku + '" value="' + machines[i].sku + '">' + machines[i].name + '</option>';
        }

        var takefrom = 0;
        console.log(data);
        SelAllOrders = data;
        thisData = data;
        thisPage = 'Orders';
        var html = '';
        var heads = ['Row', 'Menu', 'Notes', 'Move', 'Order Date', 'Started', 'Production Machine', 'Labelling Machine', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Order ID',
            'Code', 'Description', 'Priority', 'Customer', 'Brand', 'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Use Comb', 'Combs',  
             'Backed by Premixed Serum', 'Backed by Premixed Stimulant', 'Backed by Branded Packaged', 'Production Status', 'Printing Status', 'Labelling Status', 'Packaging Status', 'FINAL STATUS'
        ];

        var keys = ['row', 'menu', 'notes', 'move', 'orderdate', 'runtime', 'machineP', 'machineL', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'orderID', 'productcode', 'productdescription', 'priority', 'customer',
            'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'usecomb', 'combs',   'premixedSerum', 'premixedStimulant',
            'backtubed', 'production_status', 'printing_status', 'labeling_status', 'packaging_status', 'final_status'
        ];
        html += '<table class="table"><thead><tr>';
        for (var i = 0; i < heads.length; i++) {
            html += '<th>' + heads[i] + '</th>';
        }
        html += '</tr>';
        html += '<tr>';
        for (var i = 0; i < heads.length; i++) {
            if (heads[i] == 'Row') {
                html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Bottles') {
                html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'QTY') {
                html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Backed by Premixed Serum') {
                html += '<th><div>PREMIX TOTAL SERUM</div><div id="premixTotalSerum' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Backed by Premixed Stimulant') {
                html += '<th><div>PREMIX TOTAL STIMULANT</div><div id="premixTotalStimulant' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Backed by Branded') {
                html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
            } else {
                html += '<th></th>';
            }

        }
        html += '</tr>';
        html += '<tr>';

        for (var l = 0; l < keys.length; l++) {
            if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
                html += '<th></th>';

            } else {
                html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

            }
        }

        html += '</tr>';
        html += '</thead><tbody>';
        var bottlesTotal = 0;
        var stockingTotal = 0;
        var qtyTotal = 0;
        var mixingTotal = 0;
        var premixTotalSerum = 0;
        var premixTotalStimulant = 0;
        var unbrandedTotal = 0;
        var brandedTotal = 0;
        var tubesTotal = 0;
        var rowsTotal = 0;
        for (var i = 0; i < data.length; i++) {
            if (data[i].wentNegative) {
                html += '<tr bgcolor="#FFC200" >';
            } else if (data[i].final_status == 'Completed') {
                html += '<tr bgcolor="#1BEF5B">';
            } else if (data[i].final_status == 'started') {
                html += '<tr bgcolor="#1BCFEF">';
            } else {
                html += '<tr>';
            }
            for (var j = 0; j < keys.length; j++) {

                if (keys[j] == 'menu') {
                    html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal" href="#editOrder' + data[i].batch + '">Edit</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#run' + data[i].batch + '">Run Order</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select' + data[i].batch + '" href="#select' + data[i].batch + '">Select</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect' + data[i].batch + '" href="#select' + data[i].batch + '">Deselect</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteOrder' + data[i].batch + '">Delete Batch</a>';
                    html += '<a class="dropdown-item" onclick="return deleteandreverseSingle(this);" batch="' + data[i].batch + '">Delete and Reverse Batch</a>';
                    html += '<a class="dropdown-item" onclick="return reverseSingle(this);" batch="' + data[i].batch + '">Reverse Batch</a>';
                    html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';
                    html += ' </div></div></td>';
                } else if (keys[j] == 'row') {
                    html += '<td>' + i + '</td>';
                } else if (keys[j] == 'orderdate') {
                    html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
                } else if (keys[j] == 'packagingType.name') {
                    html += '<td>' + data[i]['packagingType']['name'] + '</td>';
                } else if (keys[j] == 'CompletionDate' || keys[j] == 'runtime') {
                    html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
                } else if (keys[j] == 'move') {
                    html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
                } else if (keys[j] == 'notes') {
                    if (notesGlobalObj[data[i].orderID]) {
                        html += '<td><div class="highlight"></div></td>';
                    } else {
                        html += '<td><div></div></td>';
                    }
                } else if (keys[j] == 'machineP') {

                    if (data[i].machineP) {
                        var selectedDropdown = machinesHTML;
                        selectedDropdown = selectedDropdown.replace('sku="' + data[i].machineP + '"', 'sku="' + data[i].machineP + '" selected');

                        html += '<td><select class="form-control"  style="width:200px;" id=machinesProduction batch="' + data[i].batch + '"  onChange=changeProdMachine(this); >' + selectedDropdown;
                    } else {
                        html += '<td><select class="form-control" style="width:200px;" id=machinesProduction batch="' + data[i].batch + '"  onChange=changeProdMachine(this);>' + machinesHTML;
                    }

                    html += '</select></td>';

                } else if (keys[j] == 'machineL') {
                    if (data[i].machineL) {
                        html += '<td><select class="form-control" style="width:200px;" id=machinesLabelling onChange=changeLabelMachine(this); batch="' + data[i].batch + '" ><option factory="' + data[i].factory + '" value="' + data[i].machineL + '">' + data[i].machineL + '</option>';
                    } else {
                        html += '<td><select class="form-control" style="width:200px;" id=machinesLabelling batch="' + data[i].batch + '"  onChange=changeLabelMachine(this);><option ></option>';
                    }

                } else {
                    html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
                }

            }
            rowsTotal++;
            bottlesTotal += parseInt(data[i].bottles, 10);
            if (data[i].QTY) {
                qtyTotal += data[i].QTY;
            }
          
            premixTotalSerum += parseInt(data[i].premixedSerum, 10);
            premixTotalStimulant += parseInt(data[i].premixedStimulant, 10);
           
            tubesTotal += parseInt(data[i].backtubed, 10);

            html += '</tr>';
        }

        html += '</tbody></table>';

        $('#pagebody').html(html);

        $('#bottlesTotal' + thisPage).html(bottlesTotal);
        $('#qtyTotal' + thisPage).html(qtyTotal);
        $('#premixTotalSerum' + thisPage).html(premixTotalSerum);
        $('#premixTotalStimulant' + thisPage).html(premixTotalStimulant);
        $('#tubesTotal' + thisPage).html(tubesTotal);
        $('#rowsTotal' + thisPage).html(rowsTotal);

    }
}

$('#subModalForm2').on('click', function(e) {
    var orderdate = $('#orderDate1').val();
    var delivdate = $('#deliveryDate').val();
    var paiddate = $('#paiddate').val();
    var eta = $('#eta').val();
    var desc = $('#description').val();
    var sku = $("#descriptionsku").val();
    var page = $("#descriptionpage").val();
    var key = $("#description2").val();
    var quantity = parseInt($('#quantity').val(), 10);
    var note = $('#note').val();
    var serumBatchCode = $('#serumBatchCode').val();
    var stimulantBatchCode = $('#stimulantBatchCode').val();
    var obj = {
        serumBatchCode: serumBatchCode,
        stimulantBatchCode: stimulantBatchCode,
        paiddate: paiddate,
        orderdate: orderdate,
        delivdate: delivdate,
        eta: eta,
        desc: desc,
        key: key,
        quantity: quantity,
        note: note,
        page: page,
        sku: sku
    };
    console.log(obj);
    google.script.run.withSuccessHandler(newItemSuccess).saveItem(obj);

    $('#orderDate1').val('');
    $('#deliveryDate').val('');
    $('#paiddate').val('');
    $('#eta').val('');
    $('#description').val('');
    $("#descriptionsku").val('');
    $("#descriptionpage").val('');
    $("#description2").val('');
    $('#quantity').val('');
    $('#note').val('');

});

function newItemSuccess(e) {
    filterpage('xx', true);
    // google.script.run.withSuccessHandler(buildInventory).getInventoryData();
    alert(e);

}

function populateInventoryTab() {
    //  google.script.run.withSuccessHandler(buildInventory).getInventoryData();
    filterpage('xx', true);
}

function buildInventory(data) {
    var html = '';

    html += '<table class="table table-striped"><thead><tr><th>Menu</th><th>Row</th><th>Description</th><th>Order Date</th><th>Delivery Date</th><th>Paid Date</th><th>ETA / Days</th><th>Order Quantity</th>';
    html += '<th>Note</th><th>Serum Batch Code</th><th>Stimulant Batch Code</th></tr></thead>';
    html += '<tbody>';
    if (data != '') {
        for (var i = 0; i < data.length; i++) {
            html += '<tr><td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
            if (data[i].quantity) {
                var quant = data[i].quantity;
            } else {
                var quant = 'null';
            }
            html += '<a class="dropdown-item" onclick="return menuClick(this);" page="' + data[i].page + '" data-toggle="modal" data-target="#myModal2" href="#editItem' + data[i].key + '">Edit</a>';

            html += '<a class="dropdown-item" onclick="return menuClick(this);" page="' + data[i].page + '" href="#deleteInv' + data[i].key + '">Delete Item</a>';
            html += ' </div></div></td>';
            html += '<td>' + data[i].row + '</td>';
            html += '<td>' + data[i].desc + '</td><td>' + formatDateDisplay(data[i].orderdate) + '</td><td>' + formatDateDisplay(data[i].delivdate) + '</td><td>' + formatDateDisplay(data[i].paiddate) + '</td>\
            <td>' + data[i].eta + '</td><td>' + quant + '</td><td>' + data[i].note + '</td><td>' + (data[i].serumBatchCode || '') + '</td><td>' + (data[i].stimulantBatchCode || '') + '</td></tr>';

        }
    }
    html += '</tbody></table>';

    $('#invbody').html(html);

}

function sortClick(event) {

    var href = event.getAttribute('href');
    href = href.slice(1, href.length);
    var sorttype = event.getAttribute('sorttype');
    console.log(sorttype + ' - ' + href + ' - ' + thisPage)
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(filterResult).sortBY(largeData, sorttype, href, thisPage);
    return false;
}

function menuClick(event) {
    var href = event.getAttribute('href');
    var extra = event.getAttribute('page');
    console.log(href);
    if (href.substr(0, 4) == '#run') {
        runItem(href.substr(4, href.length));
    } else if (href.substr(0, 10) == '#deleteInv') {
        removeFromInventory(href.substr(10, href.length), extra);
    } else if (href.substr(0, 12) == '#deleteOrder') {
        deleteItem(href.substr(12, href.length), 'Orders');
    } else if (href.substr(0, 22) == '#deleteFlavourMixOrder') {
        deleteItem(href.substr(22, href.length), 'FlavourMixOrders');
    } else if (href.substr(0, 27) == '#deleteFlavourMixMixingTeam') {
        deleteItem(href.substr(27, href.length), 'FlavourMixMixingTeam');
    } else if (href.substr(0, 21) == '#deletePremixColoring') {
        deleteItem(href.substr(21, href.length), 'PremixColoring');
    } else if (href.substr(0, 9) == '#editItem') {
        editItem(href.substr(9, href.length), extra);
    } else if (href.substr(0, 10) == '#editOrder') {
        editOrder(href.substr(10, href.length));
    } else if (href.substr(0, 7) == '#select') {
        addToSelected(href.substr(7, href.length));
    } else if (href.substr(0, 15) == '#MixingMoveNext') {
        lineItemMove(href.substr(15, href.length), 'MixingTeam');
    } else if (href.substr(0, 17) == '#deleteMixingTeam') {
        deleteItem(href.substr(17, href.length), 'MixingTeam');
    } else if (href.substr(0, 10) == '#deleteMix') {
        deleteItem(href.substr(10, href.length), 'Mixing');
    } else if (href.substr(0, 19) == '#ProductionMoveNext') {
        lineItemMove(href.substr(19, href.length), 'Production');
    } else if (href.substr(0, 17) == '#deleteProduction') {
        deleteItem(href.substr(17, href.length), 'Production');
    } else if (href.substr(0, 17) == '#PrintingMoveNext') {
        lineItemMove(href.substr(17, href.length), 'Printing');
    } else if (href.substr(0, 15) == '#deletePrinting') {
        deleteItem(href.substr(15, href.length), 'Printing');
    } else if (href.substr(0, 18) == '#LabellingMoveNext') {
        lineItemMove(href.substr(18, href.length), 'Labelling');
    } else if (href.substr(0, 16) == '#deleteLabelling') {
        deleteItem(href.substr(16, href.length), 'Labelling');
    } else if (href.substr(0, 18) == '#PackagingMoveNext') {
        lineItemMove(href.substr(18, href.length), 'Packaging');
    } else if (href.substr(0, 16) == '#deletePackaging') {
        deleteItem(href.substr(16, href.length), 'Packaging');
    } else if (href.substr(0, 13) == '#editShipping') {
        editShipping(href.substr(13, href.length));
    } else if (href.substr(0, 15) == '#deleteShipping') {
        deleteItem(href.substr(15, href.length), 'Shipping');
    } else if (href.substr(0, 8) == '#editQTY') {
        console.log(extra);
        editQTY(href.substr(8, href.length), extra);
    } else if (href.substr(0, 9) == '#printSKU') {
        generateSafetyReportsSingle(href.substr(9, href.length));
    } else if (href.substr(0, 8) == '#orderID') {
        selectNotesForBatch(href.substr(8, href.length));
    }

    return false;
}

function deselect(event) {

    var batch = event.getAttribute('page');
    addToSelected(batch);
}
var SELECTED = [];

function addToSelected(batch) {
    console.log(SELECTED);
    var check = SELECTED.indexOf(batch);
    console.log(check);

    if (check == -1) {
        SELECTED.push(batch);
        $('#deselect' + batch).css('display', 'block');
        $('#select' + batch).css('display', 'none');

        displaySelected(SELECTED);
    } else {
        $('#deselect' + batch).css('display', 'none');
        $('#select' + batch).css('display', 'block');
        SELECTED.splice(check, 1);
        displaySelected(SELECTED);
    }
}

function displaySelected(SELECTED) {
    var html = '<p>Selected:</p>';
    html += '<p>';
    for (var i = 0; i < SELECTED.length; i++) {
        html += '<button class="selVal" page="' + SELECTED[i] + '" onclick="deselect(this)" >' + SELECTED[i] + '<span class="glyphicon glyphicon-remove"></span></button>';

    }
    html += '</p>';
    console.log(selPage);
    if (selPage == 'Orders' || selPage == 'FlavourMixOrders') {
        $('#selection').html(html);
    } else if (selPage == 'Production') {
        $('#selectionProduction').html(html);
    } else if (selPage == 'Packaging') {
        $('#selectionPackaging').html(html);
    } else if (selPage == 'Printing') {
        $('#selectionPrinting').html(html);
    }
}

function runmulti() {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(multRun).bulkrun(SELECTED, selPage);

}

function runmultiSL() {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(multRun).bulkComplete(SELECTED, selPage);

}

function multRun(msg) {

    htmlModalMSG('<p>' + msg + '</p>');
    filterpage('xx', true);
    //buildOrders(SelAllOrders);
    $("#updating").css("display", "none");
}

function checkstock() {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(stockCheck).checkStockValues(SELECTED);
}

function printProduction() {
    google.script.run.withSuccessHandler(stockCheck).printProductionBatches(SELECTED);
}

function printOrders() {
    google.script.run.withSuccessHandler(stockCheck).printOrdersBatches(SELECTED);

}
//      function printPackaging(){
//     google.script.run.withSuccessHandler(stockCheck).printPackagingBatches(SELECTED);
//    }
function printPackaging() {
    google.script.run.withSuccessHandler(buildhtmlmodal).checkPackagePrinting(SELECTED);
}

function printSuccess(msg) {
    alert(msg);
}

function stockCheck(msg) {
    $("#updating").css("display", "none");
    $('#checkBatches').modal('show');
    var html = '<p >' + msg + '</p>';
    $('#checkBatchesBody').html(html);
    // alert(msg);
}

function runItem(batch) {
    console.log(batch + " " + selPage);
    if (selPage == 'Orders') {
        google.script.run.withSuccessHandler(OrderItemSuccess).runItem(batch, false);
    } else {
        google.script.run.withSuccessHandler(OrderItemSuccess).runflavourmixItem(batch);
    }

}

function OrderItemSuccess(rett) {
    console.log('rett', rett);
    //buildOrders(SelAllOrders);
    alert(rett);

    filterpage('xx', true);

}

function removeFromOrders(batch) {
    console.log(batch);

    google.script.run.withSuccessHandler(OrderItemSuccess).removefromOrders(batch);

}

function editOrder(batch) {
       $('.modal-body').html('');
    console.log(batch);
    var suffix = batch.substr(-1);
    if (suffix == 'B') {
    google.script.run.withSuccessHandler(buildOrderFormFromExistingStock).getOrderData(batch);
    
    }else{
    google.script.run.withSuccessHandler(buildOrderFormFromExisting).getOrderData(batch);
    }
}

function buildOrderFormFromExisting(retval) {
    $('#subModalForm').show();
    $('#subflavourmixFormOrder').hide();
    console.log(retval);
    var data = retval[0];
    var dataold = retval[1];
    buildForm(data);

    $('#PCSelect option[value="' + dataold.productcode + '"]').attr("selected", "selected");
    $('#PDDSelect option[value="' + dataold.productdescription + '"]').attr("selected", "selected");
    $('#customerSelect option[value="' + dataold.customerSKU + '"]').attr("selected", "selected");
    $('#bottleType option[value="' + dataold.botSKU + '"]').attr("selected", "selected");
    $('#tubeType option[value="' + dataold.tubeSKU + '"]').attr("selected", "selected");
    $('#packagingType option[value="' + dataold.packagingType.sku + '"]').attr("selected", "selected");
    $('#brandSelect option[value="' + dataold.brandSKU + '"]').attr("selected", "selected");
    $('#lidType option[value="' + dataold.lidSKU + '"]').attr("selected", "selected");
    $('#PCSelect option[value="' + dataold.productcode + '"]').attr("selected", "selected");

    $('#orderID').val(dataold.orderID);

    $('#orderDate').val(formatDateInput(dataold.orderdate));
    $('#orderbatch').val(dataold.batch);
    $('#priority').val(dataold.priority);
    if (dataold.ppp) {
        $('#prePrintedPackLabels').prop('checked', true);
    }
    if (dataold.ppb) {
        $('#prePrintedBottleLabels').prop('checked', true);
    }
    if (dataold.bottles) {
        $('#numBottles').val(dataold.bottles);
    } else {
        $('#numBottles').val(0);
    }
    if (dataold.usecomb) {
        $('#usecomb').prop('checked', true);
    }
    $('#serumBatchCode').val(dataold.serumBatchCode || '');
    $('#stimulantBatchCode').val(dataold.stimulantBatchCode || '');

    $("#updating").hide();

    if (dataold.stocking) {
        $('#stocking').val(dataold.stocking);
    } else {
        $('#stocking').val(0);
    }
    STOCKORDER = false;
    EDITORDER = true;
}

function buildOrderFormFromExistingStock(retval) {
    $('#subModalForm').show();
    $('#subflavourmixFormOrder').hide();
    console.log(retval);
    var data = retval[0];
    var dataold = retval[1];
    buildFormStock(data);

    $('#PCSelect option[value="' + dataold.productcode + '"]').attr("selected", "selected");
    $('#PDDSelect option[value="' + dataold.productdescription + '"]').attr("selected", "selected");
    $('#customerSelect option[value="' + dataold.customerSKU + '"]').attr("selected", "selected");
    $('#bottleType option[value="' + dataold.botSKU + '"]').attr("selected", "selected");
    $('#tubeType option[value="' + dataold.tubeSKU + '"]').attr("selected", "selected");
    $('#packagingType option[value="' + dataold.packagingType.sku + '"]').attr("selected", "selected");
    $('#brandSelect option[value="' + dataold.brandSKU + '"]').attr("selected", "selected");
    $('#lidType option[value="' + dataold.lidSKU + '"]').attr("selected", "selected");
    $('#PCSelect option[value="' + dataold.productcode + '"]').attr("selected", "selected");

    $('#orderID').val(dataold.orderID);

    $('#orderDate').val(formatDateInput(dataold.orderdate));
    $('#orderbatch').val(dataold.batch);
    $('#priority').val(dataold.priority);
    if (dataold.ppp) {
        $('#prePrintedPackLabels').prop('checked', true);
    }
    if (dataold.ppb) {
        $('#prePrintedBottleLabels').prop('checked', true);
    }
    if (dataold.bottles) {
        $('#numBottles').val(dataold.bottles);
    } else {
        $('#numBottles').val(0);
    }
    if (dataold.usecomb) {
        $('#usecomb').prop('checked', true);
    }
    $('#serumBatchCode').val(dataold.serumBatchCode || '');
    $('#stimulantBatchCode').val(dataold.stimulantBatchCode || '');

    $("#updating").hide();

    if (dataold.stocking) {
        $('#stocking').val(dataold.stocking);
    } else {
        $('#stocking').val(0);
    }
    STOCKORDER = true;
    EDITORDER = true;
}
var EDITORDER = false;

function changefactory(event) {
    var factory = $(event).val();
    var mixbatch = $(event).attr('batch');
    google.script.run.withSuccessHandler(updateMachine).changeFactory(mixbatch, factory);

}

function populateProductionTab() {
    google.script.run.withSuccessHandler(buildProductionTable).getSheetData('Production');

}

function buildProductionTable(data) {

    google.script.run.withSuccessHandler(buildMachinesOptions2).getMachines();

    function buildMachinesOptions2(rett) {
        var machines = rett[0];

        var html = '';
        thisData = data;
        thisPage = 'Production';
        var bottlesTotal = 0;
        var rowsTotal = 0;

        var html = '';

        var keys = ['row', 'menu', 'notes', 'move', 'orderdate', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'orderID', 'productcode', 'productdescription', 'priority', 'customer',
            'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'usecomb', 'combs', 'starttime', 'CompletionDate', 'Completed', 'Location', 'machineP'
        ];

        var heads = ['Row', 'Menu', 'Notes', 'Move', 'Order Date', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Order ID', 'Code', 'Description', 'Priority', 'Customer', 'Brand', 'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Use Comb', 'Combs',
            'Start Date', 'Completion Date', 'Production Completed', 'Location', 'Machine'
        ];

        html += '<table class="table"><thead><tr>';
        for (var i = 0; i < heads.length; i++) {
            html += '<th>' + heads[i] + '</th>';
        }
        html += '</tr>';
        html += '<tr>';
        for (var i = 0; i < heads.length; i++) {
            if (heads[i] == 'Row') {
                html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Bottles') {
                html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'QTY') {
                html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Backed by Premixed') {
                html += '<th><div>PREMIX TOTAL</div><div id="premixTotal' + thisPage + '"></div></th>';
            } else if (heads[i] == 'Backed by Branded') {
                html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
            } else {
                html += '<th></th>';
            }

        }
        html += '</tr>';
        html += '<tr>';

        for (var l = 0; l < keys.length; l++) {
            if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
                html += '<th></th>';

            } else {
                html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

            }
        }

        html += '</tr>';
        html += '</thead><tbody>';
        var bottlesTotal = 0;

        var rowsTotal = 0;
        for (var i = 0; i < data.length; i++) {
            if (data[i].wentNegative) {
                html += '<tr bgcolor="#FFC200" >';
            } else if (data[i].final_status == 'Completed') {
                html += '<tr bgcolor="#1BEF5B">';
            } else if (data[i].final_status == 'started') {
                html += '<tr bgcolor="#1BCFEF">';
            } else {
                html += '<tr>';
            }
            for (var j = 0; j < keys.length; j++) {

                if (keys[j] == 'menu') {
                    html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                    if (data[i].movedtoNext == 0) {
                        html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#ProductionMoveNext' + data[i].batch + '">Line Item Move</a>';
                    }
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select' + data[i].batch + '" href="#select' + data[i].batch + '">Select</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect' + data[i].batch + '" href="#select' + data[i].batch + '">Deselect</a>';
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteProduction' + data[i].batch + '">Delete</a>';
                    html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';
                    html += ' </div></div></td>';
                } else if (keys[j] == 'row') {
                    html += '<td>' + i + '</td>';
                } else if (keys[j] == 'orderdate') {
                    html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
                } else if (keys[j] == 'packagingType.name') {
                    html += '<td>' + data[i]['packagingType']['name'] + '</td>';
                } else if (keys[j] == 'CompletionDate' || keys[j] == 'starttime') {
                    html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
                } else if (keys[j] == 'move') {
                    html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
                } else if (keys[j] == 'notes') {
                    if (notesGlobalObj[data[i].orderID]) {
                        html += '<td><div class="highlight"></div></td>';
                    } else {
                        html += '<td><div></div></td>';
                    }
                } else if (keys[j] == 'machineP') {
                    var machinePDisp = '';
                    if (data[i].machineP) {

                        for (var m = 0; m < machines.length; m++) {
                            if (data[i].machineP == machines[m].sku) {
                                machinePDisp = machines[m].name;
                                break;
                            }
                        }

                    }
                    html += ' <td>' + machinePDisp + '</td>';

                } else {
                    html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
                }

            }
            rowsTotal++;
            bottlesTotal += parseInt(data[i].bottles, 10);

            html += '</tr>';
        }

        html += '</tbody></table>';

        $('#Productionbody').html(html);

        $('#bottlesTotal' + thisPage).html(bottlesTotal);

        $('#rowsTotal' + thisPage).html(rowsTotal);

    }
}

function populatePrintingTab() {
    google.script.run.withSuccessHandler(buildPrintingTable).getSheetData('Printing');

}

function buildPrintingTable(data) {
    SelAllOrders = data;
    var html = '';
    thisData = data;
    thisPage = 'Printing';
    var bottlesTotal = 0;
    var rowsTotal = 0;
    var botlabels = 0;
    var tubelabels = 0;

    var keys = ['row', 'menu', 'notes', 'move', 'production_status', 'orderdate', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'numLabelsBottles', 'numLabelsTubes', 'expDate', 'orderID', 'productcode', 'productdescription', 'priority', 'customer',
        'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'botlabel', 'boxname.name', 'starttime', 'CompletionDate', 'Completed', 'Location'
    ];

    var heads = ['Row', 'Menu', 'Notes', 'Move', 'Production Status', 'Order Date', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Bottle Labels QTY', 'Cylinder Labels QTY', 'Exp. Date', 'Order ID', 'Code', 'Description', 'Priority', 'Customer', 'Brand',
        'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Label', 'Outer Box',
        'Start Date', 'Completion Date', 'Production Completed', 'Location'
    ];

    html += '<table class="table"><thead><tr>';
    for (var i = 0; i < heads.length; i++) {
        html += '<th>' + heads[i] + '</th>';
    }
    html += '</tr>';
    html += '<tr>';
    for (var i = 0; i < heads.length; i++) {
        if (heads[i] == 'Row') {
            html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottles') {
            html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'QTY') {
            html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Premixed') {
            html += '<th><div>PREMIX TOTAL</div><div id="premixTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Branded') {
            html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>BOTTLE LABELS TOTAL</div><div id="numLabelsBottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>PACK LABELS TOTAL</div><div id="numLabelsTubesTotal' + thisPage + '"></div></th>';
        } else {
            html += '<th></th>';
        }

    }
    html += '</tr>';
    html += '<tr>';

    for (var l = 0; l < keys.length; l++) {
        if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
            html += '<th></th>';

        } else {
            html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

        }
    }

    html += '</tr>';
    html += '</thead><tbody>';
    var bottlesTotal = 0;

    var rowsTotal = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i].wentNegative) {
            html += '<tr bgcolor="#FFC200" >';
        } else if (data[i].final_status == 'Completed') {
            html += '<tr bgcolor="#1BEF5B">';
        } else if (data[i].final_status == 'started') {
            html += '<tr bgcolor="#1BCFEF">';
        } else {
            html += '<tr>';
        }
        for (var j = 0; j < keys.length; j++) {

            if (keys[j] == 'menu') {
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                if (data[i].movedtoNext == 0) {
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#PrintingMoveNext' + data[i].batch + '">Line Item Move</a>';
                }
                html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select' + data[i].batch + '" href="#select' + data[i].batch + '">Select</a>';

                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deletePrinting' + data[i].batch + '">Delete</a>';

                html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';

                html += ' </div></div></td>';
            } else if (keys[j] == 'row') {
                html += '<td>' + i + '</td>';
            } else if (keys[j] == 'orderdate') {
                html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'packagingType.name') {
                html += '<td>' + data[i]['packagingType']['name'] + '</td>';
            } else if (keys[j] == 'boxname.name') {
                html += '<td>' + data[i]['boxname']['name'] + '</td>';
            } else if (keys[j] == 'CompletionDate' || keys[j] == 'starttime') {
                html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'move') {
                html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
            } else if (keys[j] == 'notes') {
                if (notesGlobalObj[data[i].orderID]) {
                    html += '<td><div class="highlight"></div></td>';
                } else {
                    html += '<td><div></div></td>';
                }
            } else if (keys[j] == 'machineP') {
                var machinePDisp = '';
                if (data[i].machineP) {

                    for (var m = 0; m < machines.length; m++) {
                        if (data[i].machineP == machines[m].sku) {
                            machinePDisp = machines[m].name;
                            break;
                        }
                    }

                }
                html += ' <td>' + machinePDisp + '</td>';

            } else {
                html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
            }

        }
        rowsTotal++;
        bottlesTotal += parseInt(data[i].bottles, 10);
        botlabels += parseInt(data[i].numLabelsBottles, 10);
        tubelabels += parseInt(data[i].numLabelsTubes, 10);

        html += '</tr>';
    }

    html += '</tbody></table>';

    $('#Printingbody').html(html);
    $('#bottlesTotal' + thisPage).html(bottlesTotal);
    $('#rowsTotal' + thisPage).html(rowsTotal);
    $('#numLabelsBottlesTotal' + thisPage).html(botlabels);
    $('#numLabelsTubesTotal' + thisPage).html(tubelabels);

}

function populateLabellingTab() {
    google.script.run.withSuccessHandler(buildLabellingTable).getSheetData('Labelling');

}

function buildLabellingTable(data) {
    var html = '';
    thisData = data;
    thisPage = 'Labelling';
    var bottlesTotal = 0;
    var rowsTotal = 0;

    var keys = ['row', 'menu', 'notes', 'move', 'production_status', 'orderdate', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'orderID', 'productcode', 'productdescription', 'priority', 'customer',
        'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'botlabel', 'boxname.name', 'starttime', 'CompletionDate', 'Completed', 'Location'
    ];

    var heads = ['Row', 'Menu', 'Notes', 'Move', 'Production Status', 'Order Date', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Order ID', 'Code', 'Description', 'Priority', 'Customer', 'Brand',
        'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Label', 'Outer Box',
        'Start Date', 'Completion Date', 'Production Completed', 'Location'
    ];

    html += '<table class="table"><thead><tr>';
    for (var i = 0; i < heads.length; i++) {
        html += '<th>' + heads[i] + '</th>';
    }
    html += '</tr>';
    html += '<tr>';
    for (var i = 0; i < heads.length; i++) {
        if (heads[i] == 'Row') {
            html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottles') {
            html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'QTY') {
            html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Premixed') {
            html += '<th><div>PREMIX TOTAL</div><div id="premixTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Branded') {
            html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>BOTTLE LABELS TOTAL</div><div id="numLabelsBottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>PACK LABELS TOTAL</div><div id="numLabelsTubesTotal' + thisPage + '"></div></th>';
        } else {
            html += '<th></th>';
        }

    }
    html += '</tr>';
    html += '<tr>';

    for (var l = 0; l < keys.length; l++) {
        if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
            html += '<th></th>';

        } else {
            html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

        }
    }

    html += '</tr>';
    html += '</thead><tbody>';
    var bottlesTotal = 0;

    var rowsTotal = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i].wentNegative) {
            html += '<tr bgcolor="#FFC200" >';
        } else if (data[i].final_status == 'Completed') {
            html += '<tr bgcolor="#1BEF5B">';
        } else if (data[i].final_status == 'started') {
            html += '<tr bgcolor="#1BCFEF">';
        } else {
            html += '<tr>';
        }
        for (var j = 0; j < keys.length; j++) {

            if (keys[j] == 'menu') {
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                if (data[i].movedtoNext == 0) {
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#LabellingMoveNext' + data[i].batch + '">Line Item Move</a>';
                }
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteLabelling' + data[i].batch + '">Delete</a>';

                html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';

                html += ' </div></div></td>';
            } else if (keys[j] == 'row') {
                html += '<td>' + i + '</td>';
            } else if (keys[j] == 'orderdate') {
                html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'packagingType.name') {
                html += '<td>' + data[i]['packagingType']['name'] + '</td>';
            } else if (keys[j] == 'boxname.name') {
                html += '<td>' + data[i]['boxname']['name'] + '</td>';
            } else if (keys[j] == 'CompletionDate' || keys[j] == 'starttime') {
                html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'move') {
                html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
            } else if (keys[j] == 'notes') {
                if (notesGlobalObj[data[i].orderID]) {
                    html += '<td><div class="highlight"></div></td>';
                } else {
                    html += '<td><div></div></td>';
                }
            } else if (keys[j] == 'machineP') {
                var machinePDisp = '';
                if (data[i].machineP) {

                    for (var m = 0; m < machines.length; m++) {
                        if (data[i].machineP == machines[m].sku) {
                            machinePDisp = machines[m].name;
                            break;
                        }
                    }

                }
                html += ' <td>' + machinePDisp + '</td>';

            } else {
                html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
            }

        }
        rowsTotal++;
        bottlesTotal += parseInt(data[i].bottles, 10);

        html += '</tr>';
    }

    html += '</tbody></table>';

    $('#Labellingbody').html(html);
    $('#bottlesTotal' + thisPage).html(bottlesTotal);
    $('#rowsTotal' + thisPage).html(rowsTotal);

}

function populatePackagingTab() {
    google.script.run.withSuccessHandler(buildPackagingTable).getSheetData('Packaging');

}

function buildPackagingTable(data) {
    var html = '';
    thisData = data;
    thisPage = 'Packaging';
    var bottlesTotal = 0;
    var rowsTotal = 0;

    var keys = ['row', 'menu', 'notes', 'move', 'production_status', 'printing_status', 'orderdate', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'orderID', 'productcode', 'productdescription', 'PRINTCODE', 'priority', 'customer',
        'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'boxname.name', 'starttime', 'CompletionDate', 'final_status', 'Location'
    ];

    var heads = ['Row', 'Menu', 'Notes', 'Move', 'Production Status', 'Printing Status', 'Order Date', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Order ID', 'Code', 'Description', 'Packaging Code', 'Priority', 'Customer', 'Brand',
        'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Outer Box',
        'Start Date', 'Completion Date', 'Packaging Completed', 'Location'
    ];

    html += '<table class="table"><thead><tr>';
    for (var i = 0; i < heads.length; i++) {
        html += '<th>' + heads[i] + '</th>';
    }
    html += '</tr>';
    html += '<tr>';
    for (var i = 0; i < heads.length; i++) {
        if (heads[i] == 'Row') {
            html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottles') {
            html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'QTY') {
            html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Premixed') {
            html += '<th><div>PREMIX TOTAL</div><div id="premixTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Branded') {
            html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>BOTTLE LABELS TOTAL</div><div id="numLabelsBottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>PACK LABELS TOTAL</div><div id="numLabelsTubesTotal' + thisPage + '"></div></th>';
        } else {
            html += '<th></th>';
        }

    }
    html += '</tr>';
    html += '<tr>';

    for (var l = 0; l < keys.length; l++) {
        if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
            html += '<th></th>';

        } else {
            html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

        }
    }

    html += '</tr>';
    html += '</thead><tbody>';
    var bottlesTotal = 0;

    var rowsTotal = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i].wentNegative) {
            html += '<tr bgcolor="#FFC200" >';
        } else if (data[i].final_status == 'Completed') {
            html += '<tr bgcolor="#1BEF5B">';
        } else if (data[i].final_status == 'started') {
            html += '<tr bgcolor="#1BCFEF">';
        } else {
            html += '<tr>';
        }
        for (var j = 0; j < keys.length; j++) {

            if (keys[j] == 'menu') {
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
                if (data[i].movedtoNext == 0) {
                    html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#PackagingMoveNext' + data[i].batch + '">Line Item Move</a>';
                }
                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deletePackaging' + data[i].batch + '">Delete</a>';

                html += '<a class="dropdown-item" onclick="return menuClick(this);" id="select' + data[i].batch + '" href="#select' + data[i].batch + '">Select</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" style="display:none;" id="deselect' + data[i].batch + '" href="#select' + data[i].batch + '">Deselect</a>';

                html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';

                html += ' </div></div></td>';
            } else if (keys[j] == 'row') {
                html += '<td>' + i + '</td>';
            } else if (keys[j] == 'orderdate') {
                html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'packagingType.name') {
                html += '<td>' + data[i]['packagingType']['name'] + '</td>';
            } else if (keys[j] == 'boxname.name') {
                html += '<td>' + data[i]['boxname']['name'] + '</td>';
            } else if (keys[j] == 'CompletionDate' || keys[j] == 'starttime') {
                html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'move') {
                html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
            } else if (keys[j] == 'notes') {
                if (notesGlobalObj[data[i].orderID]) {
                    html += '<td><div class="highlight"></div></td>';
                } else {
                    html += '<td><div></div></td>';
                }
            } else if (keys[j] == 'machineP') {
                var machinePDisp = '';
                if (data[i].machineP) {

                    for (var m = 0; m < machines.length; m++) {
                        if (data[i].machineP == machines[m].sku) {
                            machinePDisp = machines[m].name;
                            break;
                        }
                    }

                }
                html += ' <td>' + machinePDisp + '</td>';

            } else {
                html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
            }

        }
        rowsTotal++;
        bottlesTotal += parseInt(data[i].bottles, 10);

        html += '</tr>';
    }

    html += '</tbody></table>';

    $('#Packagingbody').html(html);
    $('#bottlesTotal' + thisPage).html(bottlesTotal);
    $('#rowsTotal' + thisPage).html(rowsTotal);

}

function populateShippingTab() {
    google.script.run.withSuccessHandler(buildShippingTable).getShippingData();

}



function buildShippingTable(data) {
    var html = '';
    thisData = data;
    thisPage = 'Shipping';
    var bottlesTotal = 0;
    var rowsTotal = 0;

    var keys = ['row', 'menu', 'notes', 'orderdate', 'batch', 'serumBatchCode', 'stimulantBatchCode', 'orderID', 'priority', 'productcode', 'productdescription', 'PRINTCODE', 'customer',
        'brand', 'bottles', 'btype', 'lid', 'tubeType', 'packagingType.name', 'final_status', 'shipping_status', 'SHIPPINGCODE', 'dateshipped', 'trackingNo', 'datedelivered', 'Location', 'partialProduction', 'partialPackaging'
    ]
    var heads = ['Row', 'Menu', 'Notes', 'Order Date', 'Batch', 'Serum Batches', 'Stimulant Batches', 'Order ID', 'Priority', 'Code', 'Description', 'Packaging Code', 'Customer', 'Brand',
        'Bottles', 'Bottle Type', 'Lid Type', 'Tube Type', 'Pack Type', 'Status',
        'Shipping Status', 'Shipping Code', 'Date Shipped', 'Tracking No.', 'Date Delivered', 'Location', 'Partial Production', 'Partial Packaging'
    ];

    html += '<table class="table"><thead><tr>';
    for (var i = 0; i < heads.length; i++) {
        html += '<th>' + heads[i] + '</th>';
    }
    html += '</tr>';
    html += '<tr>';
    for (var i = 0; i < heads.length; i++) {
        if (heads[i] == 'Row') {
            html += '<th><div>ROWS TOTAL</div><div id="rowsTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottles') {
            html += '<th><div>BOTTLES TOTAL</div><div id="bottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'QTY') {
            html += '<th><div>QTY TOTAL</div><div id="qtyTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Premixed') {
            html += '<th><div>PREMIX TOTAL</div><div id="premixTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Backed by Branded') {
            html += '<th><div>TUBES TOTAL</div><div id="tubesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>BOTTLE LABELS TOTAL</div><div id="numLabelsBottlesTotal' + thisPage + '"></div></th>';
        } else if (heads[i] == 'Bottle Labels QTY') {
            html += '<th><div>PACK LABELS TOTAL</div><div id="numLabelsTubesTotal' + thisPage + '"></div></th>';
        } else {
            html += '<th></th>';
        }

    }
    html += '</tr>';
    html += '<tr>';

    for (var l = 0; l < keys.length; l++) {
        if (keys[l] == 'row' || keys[l] == 'menu' || keys[l] == 'notes' || keys[l] == 'move') {
            html += '<th></th>';

        } else {
            html += '<th><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Sort By<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#' + keys[l] + '" sorttype="HL" onclick="return sortClick(this);">High - Low/Z - A</a></li><li><a sorttype="LH" href="#' + keys[l] + '" onclick="return sortClick(this);">Low - High/A - Z</a></li></ul></div></th>';

        }
    }

    html += '</tr>';
    html += '</thead><tbody>';
    var bottlesTotal = 0;

    var rowsTotal = 0;
    for (var i = 0; i < data.length; i++) {

        html += '<tr>';

        for (var j = 0; j < keys.length; j++) {

            if (keys[j] == 'menu') {
                html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';

                html += '<a class="dropdown-item" onclick="return menuClick(this);" href="#deleteShipping' + data[i].batch + '">Delete Batch</a>';
                html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal3" href="#editShipping' + data[i].batch + '">Edit</a>';

                html += '<a class="dropdown-item"   value="' + data[i].orderID + '" onclick="return menuClick(this);" href="#orderID' + data[i].orderID + '">Notes</a>';

                html += ' </div></div></td>';
            } else if (keys[j] == 'row') {
                html += '<td>' + i + '</td>';
            } else if (keys[j] == 'orderdate'|| keys[j] == 'dateshipped') {
                html += '<td>' + formatDateDisplay(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'packagingType.name') {
                html += '<td>' + data[i]['packagingType']['name'] + '</td>';
            } else if (keys[j] == 'boxname.name') {
                html += '<td>' + data[i]['boxname']['name'] + '</td>';
            } else if (keys[j] == 'CompletionDate' || keys[j] == 'starttime') {
                html += '<td>' + formatDateDisplay2(data[i][keys[j]]) + '</td>';
            } else if (keys[j] == 'move') {
                html += '<td><button page="Orders" batch="' + data[i].batch + '" onclick="moveUp(this)" id="moveUP"><i class="fa fa-arrow-up" aria-hidden="true"></i></button><button onclick="moveDown(this)" page="Orders" batch="' + data[i].batch + '" id="moveDOWN"><i class="fa fa-arrow-down" aria-hidden="true"></i></button></td>';
            } else if (keys[j] == 'notes') {
                if (notesGlobalObj[data[i].orderID]) {
                    html += '<td><div class="highlight"></div></td>';
                } else {
                    html += '<td><div></div></td>';
                }
            } else if (keys[j] == 'machineP') {
                var machinePDisp = '';
                if (data[i].machineP) {

                    for (var m = 0; m < machines.length; m++) {
                        if (data[i].machineP == machines[m].sku) {
                            machinePDisp = machines[m].name;
                            break;
                        }
                    }

                }
                html += ' <td>' + machinePDisp + '</td>';

            } else {
                html += '<td>' + (data[i][keys[j]] || ' ') + '</td>';
            }

        }
        rowsTotal++;
        bottlesTotal += parseInt(data[i].bottles, 10);

        html += '</tr>';
    }

    html += '</tbody></table>';

    $('#Shippingbody').html(html);
    $('#bottlesTotal' + thisPage).html(bottlesTotal);
    $('#rowsTotal' + thisPage).html(rowsTotal);

}

function editShipping(batch) {
    console.log(batch);
    google.script.run.withSuccessHandler(buildShippingFormFromExisting).getSingleShippingData(batch);
}

function buildShippingFormFromExisting(data) {
    console.log(data);
    var html = '';

    html += '<table class="form_table">';
    html += '<tr><td><h4>Batch</h4></td><td><h4>Order ID</h4></td><td><h4>Shipping Status</h4></td><td><h4>Date Shipped</h4></td><td><h4>Tracking No.</h4></td><td><h4>Date Delivered</h4></td><td><h4>Location</h4></td></tr>';
    html += '<tr><td><div class="input-group"><input type="text" id="shippingbatch" class="form-control" value="' + data.batch + '" placeholder="' + data.batch + '" disabled aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="orderID" class="form-control" placeholder="Order ID" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="shipping_status" class="form-control" placeholder="Shipping Status" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="date" id="dateshipped" class="form-control" placeholder="Date Shipped" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="trackingNo" class="form-control" placeholder="Tracking No." aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="date" id="datedelivered" class="form-control" placeholder="Date Delivered" aria-describedby="sizing-addon2"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="shippinglocation" class="form-control" placeholder="Location" aria-describedby="sizing-addon2"></div></td>';
    html += '</tr></table>'

    $('.modal-body3').html(html);

    $('#orderID').val(data.orderID);
    $('#shipping_status').val(data.shipping_status);
    $('#dateshipped').val(data.dateshipped);
    $('#trackingNo').val(data.trackingNo);
    $('#datedelivered').val(data.datedelivered);
    $('#shippinglocation').val(data.Location);

}

$('#subModalForm3').on('click', function(e) {
    var batch = $('#shippingbatch').val();
    var orderID = $('#orderID').val();
    var shipping_status = $('#shipping_status').val();
    var dateshipped = $('#dateshipped').val();
    var trackingNo = $('#trackingNo').val();
    var datedelivered = $('#datedelivered').val();
    var Location = $('#shippinglocation').val();
    var obj = {
        orderID: orderID,
        shipping_status: shipping_status,
        dateshipped: dateshipped,
        trackingNo: trackingNo,
        datedelivered: datedelivered,
        Location: Location
    };
    console.log(batch);
    console.log(obj);
    google.script.run.withSuccessHandler(refreshShipping).updateShippingItem(batch, obj);

});

function refreshShipping() {
    populateShippingTab();
}

function populateQTYTab(page) {
    $("#updating").css("display", "block");
    console.log('started');
    console.log('page', page);
     $('#QTYbody').html('');
    google.script.run.withSuccessHandler(splitPages).getQTY(page);
}

function populateQTYTable(data, page) {

    var html = '';
 $('#QTYbody').html(html);
    html += '<table class="table"><thead><tr><th>Row</th><th>SKU</th><th>Menu</th><th>Name</th><th>Running</th><th>Reserved</th><th>Completed</th><th>Stock on Order</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < data.length; i++) {
        try {

            if (data[i] == null) {
                continue;
            }
            if (!data[i].sku) {
                continue;
            }
            if (isNaN(data[i].Running)) {
                data[i].Running = 0;
            }
            if (isNaN(data[i].Reserved)) {
                data[i].Reserved = 0;
            }
            if (isNaN(data[i].Completed)) {
                data[i].Completed = 0;
            }
            html += '<tr>';
            html += '<td>' + i + '</td>';
            html += '<td>' + data[i].sku + '</td>';

            html += '<td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';

  
                html += '<a class="dropdown-item" onclick="return menuClick(this);" data-toggle="modal" data-target="#myModal4" page="' + page + '" href="#editQTY' + data[i].sku + '">Edit</a>';
                if (page == 'PremixesTypes') {
                    html += '<a class="dropdown-item" onclick="return menuClick(this);"page="' + page + '" href="#printSKU' + data[i].sku + '">Print</a></div></div></td>';
                } else {
                    html += '</div></div></td>';
                }
         
            if (  page == 'PremixesTypes') {
                html += '<td>' + data[i].name + '</td><td>' + parseFloat(data[i].Running).toFixed(2) + '</td><td>' + parseFloat(data[i].Reserved).toFixed(2) + '</td><td>' + parseFloat(data[i].Completed).toFixed(2) + '</td>';
            } else {
                html += '<td>' + data[i].name + '</td><td>' + data[i].Running + '</td><td>' + data[i].Reserved + '</td><td>' + data[i].Completed + '</td>';

            }
            if (data[i].Stock) {
                html += '<td>' + data[i].Stock + '</td></tr>';
            } else {
                html += '<td>0</td></tr>';
            }

        } catch (e) {
            console.log(data[i], e);
        }
    }
    html += '</tbody></table>';
    $("#updating").css("display", "none");
    console.log('done');
    $('#QTYbody').html(html);

}

var editpage;

function editQTY(id, page) {
    editpage = page;

    google.script.run.withSuccessHandler(buildQTYFormFromExisting).getSingleQTYData(id, page);

}

function buildQTYFormFromExisting(dat) {
    var data = dat.data;
    var page = dat.page;
    //  console.log(data);
    var html = '';
    html += '<table class="form_table">';

    html += '<tr><td><h4>' + data.name + '</h4></td><td><tr>';
   
        html += '<tr><td><div class="input-group"><input type="text" id="qtyID" value ="' + data.sku + '" class="form-control" placeholder="' + data.sku + '" disabled aria-describedby="sizing-addon1"></div></td></tr>';
        html += '<tr><td><div class="input-group"><input type="text" id="qtyname" value ="' + data.name + '" class="form-control" placeholder="' + data.name + '"  aria-describedby="sizing-addon1"></div></td></tr>';
    
    html += '</table><table class="form_table">'
    html += '<tr><td><h4>Running</h4></td><td><h4>Reserved</h4></td><td><h4>Completed</h4></td></tr>';

    html += '<tr><td><div class="input-group"><input type="text" id="Running" class="form-control" aria-describedby="sizing-addon1"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="Reserved" class="form-control"  aria-describedby="sizing-addon1"></div></td>';
    html += '<td><div class="input-group"><input type="text" id="Completed" class="form-control" aria-describedby="sizing-addon1"></div></td></tr>';

    html += '</table>';
    $('.modal-body4').html(html);
    $('#Completed').val(data.Completed);
    $('#Running').val(data.Running);
    $('#Reserved').val(data.Reserved);
    $('#qtyname').val(data.name);

}

$('#subModalForm4').on('click', function(e) {
    var dataname = $('#qtyID').val();
    if (editpage == 'Flavours' || editpage == 'PremixesTypes') {
        var Running = parseFloat($('#Running').val());
        var Reserved = parseFloat($('#Reserved').val());
        var Completed = parseFloat($('#Completed').val());
    } else {
        var Running = parseInt($('#Running').val(), 10);
        var Reserved = parseInt($('#Reserved').val(), 10);
        var Completed = parseInt($('#Completed').val(), 10);
    }
    var name = $('#qtyname').val();
    var obj = {
        Completed: Completed,
        Reserved: Reserved,
        Running: Running,
        name: name,

    };
    console.log(obj);
    google.script.run.withSuccessHandler(populateQTYTab).updatesingleQTY(dataname, editpage, obj);

});

function refreshQTY(page) {
    populateQTYTab(page);
}

function populateLocationsTab() {
    google.script.run.withSuccessHandler(refreshLocations).getLocations();

}

function refreshLocations(fulldata) {
    var Production = fulldata[0];
    var Printing = fulldata[1];
    var Labelling = fulldata[2];
    var Packaging = fulldata[3];
    var shipping = fulldata[4];
   

    var html = '';
    html += '<table class="table table-striped"><thead><tr><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Shipping</th></tr></thead>';
    html += '<tr><td><table class="table table-striped">';
    html += '<thead><tr><th>Batch</th><th>Code</th><th>Location</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < Production.length; i++) {

        html += '<tr><th>' + Production[i].batch + '</th><th>' + Production[i].productcode + '</th><th>' + Production[i].Location + '</th></tr>'

    }
    html += '</tbody></table></td>';

    html += '<td><table class="table table-striped">';
    html += '<thead><tr><th>Batch</th><th>Code</th><th>Location</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < Printing.length; i++) {

        html += '<tr><th>' + Printing[i].batch + '</th><th>' + Printing[i].productcode + '</th><th>' + Printing[i].Location + '</th></tr>'

    }
    html += '</tbody></table></td>';

    html += '<td><table class="table table-striped">';
    html += '<thead><tr><th>Batch</th><th>Code</th><th>Location</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < Labelling.length; i++) {
  
        html += '<tr><th>' + Labelling[i].batch + '</th><th>' + Labelling[i].productcode + '</th><th>' + Labelling[i].Location + '</th></tr>'

    }
    html += '</tbody></table></td>';

    html += '<td><table class="table table-striped">';
    html += '<thead><tr><th>Batch</th><th>Code</th><th>Location</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < Packaging.length; i++) {

        html += '<tr><th>' + Packaging[i].batch + '</th><th>' + Packaging[i].productcode + '</th><th>' + Packaging[i].Location + '</th></tr>'

    }
    html += '</tbody></table></td>';

    html += '<td><table class="table table-striped">';
    html += '<thead><tr><th>Batch</th><th>Code</th><th>Location</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < shipping.length; i++) {

        html += '<tr><th>' + shipping[i].batch + '</th><th>' + shipping[i].productcode + '</th><th>' + shipping[i].Location + '</th></tr>'

    }
    html += '</tbody></table></td></tr></tbody></table>';

    $('#Locationbody').html(html);

}

function deleteItem(batch, tab) {
    google.script.run.withSuccessHandler(lineItemResult).removeItem(batch, tab, 'Admin');
}

function lineItemMove(batch, tab) {
    google.script.run.withSuccessHandler(lineItemResult).MoveItem(batch, tab, 'Admin');

}

function lineItemResult(e) {
    alert(e[0]);
    console.log(LASTSEARCH);
    var current = e[1];
    selPage = current;
    google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);

}

$('#subflavourForm').on('click', function(e) {
    var name = $('#flavName').val();
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Flavours');
});

$('#subflavourmixForm').on('click', function(e) {
    var special = '';
    var newFLAVOURSARR = [];
    if (EDIT_FLAVMIX_CONST) {

        special = '.editflavourmixBody #e';
    } else {
        special = '.newflavourmixBody #';
    }

    var obj = {
        sku: $(special + 'flavourmixSKU').val(),
        name: $(special + 'flavourmixName').val(),
        flavours: {},

    };
    if (obj.sku == '') {
        alert('No SKU.');
        return 0;
    }
    for (var i = 1; i <= flavournum; i++) {
        console.log('i', i, 'flavournum', flavournum);
        if (NEWFLAVOURSINFLAVOURMIX.indexOf(i.toString()) >= 0) {
            var flavoursku = $(special + 'flavourSelectSKU' + i).val();
            var name = $(special + 'flavourSelectNAME' + i).val();
            var val = $(special + 'flavourAmount' + i).val()
            var BASEflavour = {
                sku: flavoursku,
                name: name,
            };
            newFLAVOURSARR.push(BASEflavour);
            //google.script.run.withSuccessHandler(newflavourSuccess).newBasicItem(BASEflavour, 'Flavours');
            obj.flavours[flavoursku] = {
                sku: flavoursku,
                val: val,
                name: name,
            };
        } else {
            var flavoursku = $(special + 'flavourSelect' + i).val();
            var name = $(special + 'flavourSelect' + i + ' option:selected').text();
            var val = $(special + 'flavourAmount' + i).val()
            obj.flavours[flavoursku] = {
                sku: flavoursku,
                val: val,
                name: name,
            };

        }
    }

    if (EDIT_FLAVMIX_CONST) {

        if (OLDITEM) {
            if (obj.sku != OLDITEM.sku) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.sku = OLDITEM.sku;
            }
            OLDITEM = {};
        }
    }

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'FlavourMixes');
    $(special + 'flavourmixSKU').val('');
    $(special + 'flavourmixName').val('');
    $(special + 'flavourDropdowns').html('');
    if (newFLAVOURSARR.length > 0) {
        google.script.run.withSuccessHandler(newbasicitemsuccess).newFlavoursArray(newFLAVOURSARR);
    }
});

$('#subCustomerForm').on('click', function(e) {
    var obj = {
        name: $('#custName').val(),
        address: $('#custAddress').val(),
    }

    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Customers');
});

$('#subBottleForm').on('click', function(e) {
    var name = $('#bottletypeinput').val();
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'BottleTypes');
});
$('#subBrandForm').on('click', function(e) {
    var name = $('#brandid').val();
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Brands');
});

$('#subLidForm').on('click', function(e) {
    var name = $('#lidid').val();
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Lids');
});
$('#subMiscForm').on('click', function(e) {
    var name = $('#miscid').val();
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(name, 'Misc');
});

$('#subBoxForm').on('click', function(e) {

    var special = '';
    if (EDIT_BOX_CONST) {

        special = '.editBoxBody #e';
    } else {
        special = '.newBoxBody #';
    }

    var obj = {
        sku: $(special + 'boxSKU').val(),
        name: $(special + 'boxName').val(),
        divTubesForBox: parseInt($(special + 'divTubesForBox').val(), 10),

    };

    if (obj.sku == '') {
        alert('No SKU.');
        return 0;
    }

    if (EDIT_BOX_CONST) {

        if (OLDITEM) {
            if (obj.sku != OLDITEM.sku) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.sku = OLDITEM.sku;
            }
            OLDITEM = {};
        }
    }

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Boxes');
    $(special + 'boxSKU').val('');
    $(special + 'boxName').val('');
    $(special + 'divTubesForBox').val('');

});

$('#subLabelForm').on('click', function(e) {

    var special = '';
    if (EDIT_LABEL_CONST) {

        special = '.editLabelBody #e';
    } else {
        special = '.newLabelBody #';
    }

    var obj = {
        sku: $(special + 'LabelSKU').val(),
        name: $(special + 'LabelName').val(),

    };

    if (obj.sku == '') {
        alert('No SKU.');
        return 0;
    }

    if (EDIT_LABEL_CONST) {

        if (OLDITEM) {
            if (obj.sku != OLDITEM.sku) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.sku = OLDITEM.sku;
            }
            OLDITEM = {};
        }
    }

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Labels');
    $(special + 'LabelSKU').val('');
    $(special + 'LabelName').val('');

});

$('#subColorForm').on('click', function(e) {

    var special = '';
    if (EDIT_COLOR_CONST) {

        special = '.editColorBody #e';
    } else {
        special = '.newColorBody #';
    }

    var obj = {
        sku: $(special + 'ColorSKU').val(),
        name: $(special + 'ColorName').val(),

    };

    if (obj.sku == '') {
        alert('No SKU.');
        return 0;
    }

    if (EDIT_COLOR_CONST) {

        if (OLDITEM) {
            if (obj.sku != OLDITEM.sku) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.sku = OLDITEM.sku;
            }
            OLDITEM = {};
        }
    }

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Color');
    $(special + 'ColorSKU').val('');
    $(special + 'ColorName').val('');

});
$('#subPackagingForm').on('click', function(e) {

    var special = '';
    if (EDIT_PACKAGING_CONST) {

        special = '.editPackagingBody #e';
    } else {
        special = '.newPackagingBody #';
    }

    var tubetext = $(special + 'tubelabel option:selected').text();
    var tubesku = $(special + 'tubelabel').val();
    var obj = {
        sku: $(special + 'packagingSKU').val(),
        name: $(special + 'packagingName').val(),
        botperPack: parseInt($(special + 'botperPack').val(), 10),

        tubelabel: {
            name: '',
            sku: '',
        },
        ink: parseFloat($(special + 'ink').val()),

    };

    if (obj.sku == '') {
        alert('No SKU.');
        return 0;
    }

    obj.tubelabel.sku = tubesku;
    obj.tubelabel.name = tubetext;
    if (EDIT_PACKAGING_CONST) {

        if (OLDITEM) {
            if (obj.sku != OLDITEM.sku) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.sku = OLDITEM.sku;
            }
            OLDITEM = {};
        }
    }

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Packages');
    $(special + 'packagingSKU').val('');
    $(special + 'packagingName').val('');
    $(special + 'botperPack').val('');

    $(special + 'ink').val('');

    $(special + "tubelabel select").val('');

});

$('#subRecipeForm').on('click', function(e) {
    var special = '';
    if (EDIT_RECIPE_CONST) {

        special = '.editRecipeBody #e';
    } else {
        special = '.newRecipeBody #';
    }

    var obj = {

        vgrec: parseInt($(special + 'recipeVG').val(), 10),
        pgrec: parseInt($(special + 'recipePG').val(), 10),
        agrec: parseInt($(special + 'recipeAG').val(), 10),
        cbdrec: parseInt($(special + 'recipeCBD').val(), 10),
        MCTrecipe: parseInt($(special + 'recipeMCT').val(), 10),
        nicorec: parseInt($(special + 'recipeNicotine').val(), 10),
        nicorecsalts: parseInt($(special + 'recipeNicotineSalts').val(), 10),
        Flavrec: parseInt($(special + 'recipeFlavour').val(), 10),
        vg: $(special + 'recipevgval').val(),
        pg: $(special + 'recipepgval').val(),
        strength: $(special + 'recipestrength').val(),
        Color: {
            val: '',
            name: '',
            sku: '',
        },
    };

    var keys = Object.keys(obj);
    for (var i = 0; i < keys.length; i++) {
        if (keys[i] == 'Color') {
            continue;
        }
        if (isNaN(obj[keys[i]])) {
            obj[keys[i]] = 0;
        }
    }
    if (!isNaN(parseInt($(special + 'colorpercentage').val(), 10)) && $(special + 'colorSelect').val()) {

        obj.Color.val = parseInt($(special + 'colorpercentage').val(), 10);
        obj.Color.name = $(special + 'colorSelect option:selected').text();
        obj.Color.sku = $(special + 'colorSelect').val();
    } else {
        delete obj.Color;
    }
    obj.id = $(special + 'recipeCODE').val();
    obj.name = $(special + 'recipeName').val();
    if (obj.id == '') {
        alert('No SKU.');
        return 0;
    }
    if (EDIT_RECIPE_CONST) {

        if (OLDITEM) {
            if (obj.id != OLDITEM.id) {
                alert('The unique ID can not be edited. \n Other Changes will be saved.');
                obj.id = OLDITEM.id;
            }
            OLDITEM = {};
        }
    }
    // var checked=$('#CBD').val();

    console.log(obj);
    google.script.run.withSuccessHandler(newbasicitemsuccess).newBasicItem(obj, 'Recipes');
    $(special + 'recipeName').val('');
    $(special + 'recipeVG').val('');
    $(special + 'recipePG').val('');
    $(special + 'recipeAG').val('');

    $(special + 'recipevgval').val('');
    $(special + 'recipepgval').val('');
    $(special + 'recipestrength').val('');

    $(special + 'recipeCBD').val('');
    $(special + 'recipeMCT').val('');
    $(special + 'recipeNicotine').val('');
    $(special + 'recipeNicotineSalts').val('');
    $(special + 'recipeFlavour').val('');
    $(special + 'recipeCODE').val('');
    $(special + 'colorpercentage').val('');
    $(special + 'colorSelect').val('');
});

function newbasicitemsuccess(resp) {
    alert(resp);
}

//  var file, reader = new FileReader();

$('#subCSVForm').on('click', function(e) {
    var file = $('#CSVID')[0].files[0];
    google.script.run.withSuccessHandler(newbasicitem).serverFunc(file);
});

var reader = new FileReader();
var files;
var fileCounter = 0;
reader.onloadend = function() {
    console.log('Load ended', reader.result, files[fileCounter].name);
    google.script.run.withSuccessHandler(filesuccess)
        .saveFileCsv(reader.result, files[fileCounter].name);
    $("#updating").css("display", "block");
    return false;
};

$('#save_btn').on('click', function() {
    SaveFiles();
});

function filesuccess(resp) {
    $("#updating").css("display", "none");
    $('#checkBatches').modal('show');
    var html = '<p >' + resp + '</p>';
    $('#checkBatchesBody').html(html);
    // alert(resp);
}

function SaveFiles() {
    if ($('#myFiles').val() == "") {
        showToast('Please Upload your template!');
        return 0;
    }

    var folderSelect = document.getElementById("folderSelectId");
    files = document.getElementById("myFiles").files;
    postNextFile();
}

function postNextFile() {
    if (fileCounter < files.length) {
        reader.readAsDataURL(files[fileCounter]);
    } else {
        fileCounter = 0;
        $('#myFiles').val('');
    }
}

function getSearchDates(data) {
    console.log('data', data);
    var page = selPage;
    console.log('getsearachdates', page);
    if (page == 'Functions' || page == 'Reporting') {
        return;
    }
    if (page == 'Mixing') {
        console.log('page');
        console.log(page);
        $('#searchDates' + page).show();
        $('#searchDatesMixingTeam').hide();
    } else if (page == 'MixingTeam' || page == 'FlavourMixMixingTeam' || page == 'PremixColoring') {
        console.log('page');
        console.log(page);
        page = 'MixingTeam';
        $('#searchDatesMixing').hide();
        $('#searchDatesMixingTeam').show();
    } else if (page == 'FlavourMixOrders') {
        page = 'Orders';
    }
    var dates = {
        'startDate': $('#searchDates' + page + ' #startSearch').val(),
        'endDate': $('#searchDates' + page + ' #endSearch').val(),
        'search': $('#searchDates' + page + ' #filterdates').val(),
    };
    console.log('dates', dates);
    if (dates.startDate) {
        var start = new Date(dates.startDate);
    } else {
        var start = new Date('01-01-1970');
    }
    if (dates.endDate) {
        var end = new Date(dates.endDate);
    } else {
        var end = new Date('01-01-2040');
    }
    var ret = [];
    for (var i = 0; i < data.length; i++) {
        if (!data[i][dates.search] || formatDateDisplay(data[i][dates.search]) == '') {
            //   ret.push(data[i]);
            continue;
        }
        var logitem = new Date(data[i][dates.search]);
        if (logitem.getTime()) {} else {
            var from = data[i][dates.search].replace(/\//g, '-').split("-");
            logitem = new Date(from[2], from[1], from[0]);
        }
        if (!logitem.getTime()) {
            console.log(logitem.getTime(), start.getTime(), end.getTime(), dates.search, data[i].batch);
        }
        if (start.getTime() <= logitem.getTime() && end.getTime() >= logitem.getTime()) {
            ret.push(data[i]);
        }
    }
    return ret;
}

var pagesSplit = false;
var lastPage = '';

function filterResult(rett) {

    console.log(rett);

    var page = rett[0];
    var data = rett[1] || [];
    console.log('page', page);
    if (page == 'Finctions' || page == null) {
        return;
    }
    data = getSearchDates(data);
    if (pagesSplit == false) {
        data = splitPages([data, page]);

    }

    var largeData;
    lastPage = page;

    if (page == 'Orders') {
        buildOrders(data);
    } else if (page == 'FlavourMixOrders') {
        buildFlavourMixOrdersTable(data);
    } else if (page == 'Mixing') {
        buildMixingTable(data);
    } else if (page == 'MixingTeam') {
        buildMixingTeamTable(data);
    } else if (page == 'FlavourMixMixingTeam') {
        buildFlavourMixMixingTeamTable(data);
    } else if (page == 'PremixColoring') {
        buildPremixColoringTable(data);
    } else if (page == 'Production') {
        buildProductionTable(data);
    } else if (page == 'Printing') {
        buildPrintingTable(data);
    } else if (page == 'Labelling') {
        buildLabellingTable(data);
    } else if (page == 'Packaging') {
        buildPackagingTable(data);
    } else if (page == 'Shipping') {
        buildShippingTable(data);
    } else if (page == 'Inventory') {
        buildInventory(data);
    }
    $("#updating").css("display", "none");
}

function changeSplit() {
    pagesSplit = false;
    filterpage('xx', true);
}
var splitPAGES;
var currPage;

function splitPages(rett) {

    var data = rett[0];
    var page = rett[1];
    largeData = data;

    currPage = page;

    if (data.length == 0) {
        $("#updating").css("display", "none");
        console.log('done');
        $('#Pagination').html('');
        $(activetab + ' #Pagination2').html('');
        return false;
    }
    var pages = [];
    if (selPage == 'QTY') {
        var chunk = 500;
    } else {
        console.log('splitcount: ' + activetab + ' #splitcountselect');
        var splitcount = $(activetab + ' #splitcountselect').val();
        if (splitcount != 'all') {
            var chunk = parseInt(splitcount, 10);
        } else {
            var chunk = data.length;
        }
    }
    var i, j, temparray;

    for (i = 0, j = data.length; i < j; i += chunk) {
        temparray = data.slice(i, i + chunk);
        // do whatever

        pages.push(temparray);
    }
    splitPAGES = pages;
    var toreturn = false;
    if (selPage == 'QTY') {
        populateQTYTable(pages[0], page);
    } else {
        toreturn = true;
        // pages[0];filterResult(selPage,pages[0])
    }
    var html2 = '';

    for (var k = 0; k < pages.length; k++) {
        html2 += '<button class="paginationButton" id="getPage' + k + '" onclick="switchPage(this)">' + k + '</button>';
    }

    //  $('#Paginationtop').html(html2);
    $('#Pagination').html(html2);
    $(activetab + ' #Pagination2').html(html2);
    if (toreturn) {

        return pages[0];
    }

}

function switchPage(e) {
    $(".paginationButton").css("background-color", "#f4f7f8");
    $(".paginationButton").css("color", "black");

    $(e).css("background-color", "#195685");
    $(e).css("color", "#FFF");

    var id = e.getAttribute('id');
    var index = id.substr(7, id.length);
    console.log(index);
    pagesSplit = true;
    if (selPage == 'QTY') {
        populateQTYTable(splitPAGES[index], currPage);
    } else {

        filterResult([selPage, splitPAGES[index]]);

    }
}

$('#searchQTY').on('click', function(e) {
    var page = qtySheet.substr(1, qtySheet.length);
    var word = $('#searchword').val();

    google.script.run.withSuccessHandler(splitPages).searchforWord(page, word);

});

$('#searchMixingTabs').on('click', function(e) {
    var page = MixSheet.substr(1, MixSheet.length);
    var word = $('#searchwordMixing').val();

    google.script.run.withSuccessHandler(populateMixingTabs).searchforWordMixing(page, word);

});

function populateMixingTabs(data) {
    var page = MixSheet.substr(1, MixSheet.length);
    if (page == 'Mixing') {
        buildMixingTable(data);

    } else if (page == 'MixingTeam') {
        buildMixingTeamTable(data);

    } else if (page == 'FlavourMixMixingTeam') {
        buildFlavourMixMixingTeamTable(data);

    } else if (page == 'PremixColoring') {
        buildPremixColoringTable(data);
    }
}

function changeProdMachine(event) {
    var batch = $(event).attr('batch');
    //$(event).attr('batch');
    var val = $('#machinesProduction').val();

    var factory = event.options[event.selectedIndex].getAttribute('factory')

    //var factory = $('option:selected', event).attr('factory');
    console.log(batch, val, factory);
    google.script.run.withSuccessHandler(updateMachine).updateMachineProduction(batch, val, factory);
}

function changeLabelMachine(event) {
    var batch = $(event).attr('batch');
    //$(event).attr('batch');
    var val = $('#machinesLabelling').val();
    var factory = event.options[event.selectedIndex].getAttribute('factory')
    //var factory = $('option:selected', event).attr('factory');
    console.log(batch, val, factory);
    google.script.run.withSuccessHandler(updateMachine).updateMachineLabelling(batch, val, factory);
}

function updateMachine(msg) {
    alert(msg)
        $("#updating").css("display", "none");

}

//NEW PCD

function newPDC() {
    $("#updating").css("display", "block");
    console.log('form data for building new pcd');
    google.script.run.withSuccessHandler(buildnewPCD).getFormData('');
}

function buildnewPCD(data) {
    console.log('building new pcd');
    var html = '';

    var brandSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.brands.length; i++) {
        brandSelect += '<option value="' + data.brands[i].sku + '">' + data.brands[i].name + '<option>';
    }
    $("#newPCDbrand").html(brandSelect);

    var bottleSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        bottleSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
    }
    $("#newPCDbottle").html(bottleSelect);

    var tubeSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.bottletypes.length; i++) {
        tubeSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
    }
    $("#newPCDtube").html(tubeSelect);

    var LidSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.lids.length; i++) {
        LidSelect += '<option value="' + data.lids[i].sku + '">' + data.lids[i].name + '<option>';
    }
    $("#newPCDcap").html(LidSelect);

    var packagingSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.packagings.length; i++) {
        packagingSelect += '<option id="' + data.packagings[i].sku + '"  value="' + data.packagings[i].sku + '"  >' + data.packagings[i].name + '<option>';
    }
    $("#newPCDpackaging").html(packagingSelect);

    var boxSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.boxes.length; i++) {
        boxSelect += '<option id="' + data.boxes[i].sku + '"  value="' + data.boxes[i].sku + '"  >' + data.boxes[i].name + '<option>';
    }
    $("#newboxname").html(boxSelect);

    var labelsSelect = '<option id="blank" value=""><option>';
    for (var i = 0; i < data.labels.length; i++) {
        labelsSelect += '<option id="' + data.labels[i].sku + '" value="' + data.labels[i].sku + '">' + data.labels[i].name + '<option>';
    }

    $("#newbotlabel").html(labelsSelect);
    $("#newppbotlabel").html(labelsSelect);
    $("#newpacklabel").html(labelsSelect);
    $("#newpppacklabel").html(labelsSelect);

    $("#updating").css("display", "none");

}
$('#save_new_PCD').on('click', function() {
    var productcode = $('#NPC').val();
    var productdescription = $('#NPD').val(); 
    var brandSKU = $('#newPCDbrand').val();
    var brandSelect = $('#newPCDbrand option:selected').text();


    var botSKU = $('#newPCDbottle').val();
    var bottleType = $('#newPCDbottle option:selected').text();

     var tubeSKU = $('#newPCDtube').val();
    var tubeType = $('#newPCDtube option:selected').text();

   var lidSKU = $('#newPCDcap').val();
    var lidType = $('#newPCDcap option:selected').text();

    var packagingTypesku = $('#newPCDpackaging').val();
    var packagingTypename = $('#newPCDpackaging option:selected').text();

    if (productcode.length > 20) {
        var t = productcode;
        productcode = productdescription;
        productdescription = t;
    }

    var object = {
        botlabel: $('#newbotlabel option:selected').text(),
        botlabelsku: $('#newbotlabel').val(),
        ppbotlabel: $('#newppbotlabel option:selected').text(),
        ppbotlabelsku: $('#editppbotlabel').val(),

        packlabel: $('#newpacklabel option:selected').text(),
        packlabelsku: $('#newpacklabel').val(),
        pppacklabel: $('#newpppacklabel option:selected').text(),
        pppacklabelsku: $('#newpppacklabel').val(),
        price: $('#newprice').val(),

        fill: parseInt($('#newPCDfill').val(), 10),
        boxname: {
            sku: $('#newboxname').val(),
            name: $('#newboxname option:selected').text(),
        },
        premixSKUSerum: $('#newpremixSKUSerum').val(),
        premixdescrSerum: $('#newpremixdescrSerum').val(),
        premixSKUStimulant: $('#newpremixSKUStimulant').val(),
        premixdescrStimulant: $('#newpremixdescrStimulant').val(),
        premixSKUColored: $('#newpremixSKUColored').val(),
        premixdescrColored: $('#newpremixdescrColored').val(),
        unbrandSKU: $('#newunbrandSKU').val(),
        unbranddescr: $('#newunbranddescr').val(),
        productcode: productcode,
        productdescription: productdescription,
        multipliers:{
        combs:$('#newCombMultiplier').val() ? parseInt($('#newCombMultiplier').val(),10) : 1,
        bottles:$('#newBottleMultiplier').val() ? parseInt($('#newBottleMultiplier').val(),10) : 1,
        },
        brand: brandSelect,
        brandSKU: brandSKU,
        usecomb: $('#newUseComb').is(":checked"),
        btype: bottleType,
        botSKU: botSKU,
        tubeType: tubeType,
        tubeSKU: tubeSKU,
        lidSKU: lidSKU,
        lid: lidType,

        packagingType: {
            sku: '',
            name: '',
        }, 
    };

    object.packagingType.sku = packagingTypesku;
    object.packagingType.name = packagingTypename;

    google.script.run.withSuccessHandler(updateMachine).save_PCD(object, '', false);
});

//EDIT PCD
var oldPCD;
var input1 = document.getElementById('EPC');
var optionsVal1 = document.getElementById('list1');

input1.addEventListener('keyup', show);
optionsVal1.onclick = function() {
    setVal(this);
};
RegExp.escape = function(s) {
    return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
};

function show() {
    if (this.keyCode == 13) {
        return false;
    }
    //document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById('dropdown');
    dropdown.style.display = 'none';

    optionsVal1.options.length = 0;

    if (input1.value) {
        dropdown.style.display = 'block';
        optionsVal1.size = 3;
        var textCountry = input1.value;

        for (var i = 0; i < PCArr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (PCArr[i].prod.match(testableRegExp)) {
                addValue(PCArr[i].prod, PCArr[i].prod);

            }
        }

        var size = dropdown.children[0].children;
        if (size.length > 0) {
            var defaultSize = 16;
            if (size.length < 10) {
                defaultSize *= size.length;
            } else {
                defaultSize *= 10;
            }
            dropdown.children[0].style.height = defaultSize + "px";
        }

    }
}

function addValue(text, val) {
    var createOptions = document.createElement('option');
    optionsVal1.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
}

//Settin the value in the box by firing the click event
function setVal(selectedVal) {
    input1.value = selectedVal.value;
    document.getElementById('dropdown').style.display = 'none';
}

var input2 = document.getElementById('EPD');
var optionsVal2 = document.getElementById('list2');

input2.addEventListener('keyup', show2);
optionsVal2.onclick = function() {
    setVal2(this);
};

function show2() {
    if (this.keyCode == 13) {
        return false;
    }
    //document.getElementById('list2').style.display = 'block';
    var dropdown = document.getElementById('dropdown2');
    dropdown.style.display = 'none';

    optionsVal2.options.length = 0;

    if (input2.value) {
        dropdown.style.display = 'block';
        optionsVal2.size = 3;
        var textCountry = input2.value;

        for (var i = 0; i < PDArr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (PDArr[i].descr.match(testableRegExp)) {
                addValue2(PDArr[i].descr, PCArr[i].descr);

            }
        }

        var size = dropdown.children[0].children;
        if (size.length > 0) {
            var defaultSize = 16;
            if (size.length < 10) {
                defaultSize *= size.length;
            } else {
                defaultSize *= 10;
            }
            dropdown.children[0].style.height = defaultSize + "px";
        }

    }
}

function addValue2(text, val) {
    var createOptions = document.createElement('option');
    optionsVal2.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
}

//Settin the value in the box by firing the click event
function setVal2(selectedVal) {
    input2.value = selectedVal.value;
    document.getElementById('dropdown2').style.display = 'none';
}

function editPCD() {
    google.script.run.withSuccessHandler(buildeditPCD).getPCDDropdown();
}
$('#EPC').on('keypress', function(event) {

    if (event.keyCode == 13) {
        var PC = $('#EPC').val();
        console.log('PC', PC);
        $("#updating").css("display", "block");
        console.log('form data for building edit pcd prcode');
        try {
            google.script.run.withSuccessHandler(buildeditPCD).getEPCandFormdata(PC);
                  $("#dropdown").css("display", "none"); 
        } catch (e) {
            $("#updating").css("display", "none");
        }

    }
});

$('#EPD').on('keypress', function(event) {
    console.log('in');
    if (event.keyCode == 13) {

        var PD = $('#EPD').val();
        var PC = '';
        for(var i = 0 ; i < PDArr.length ; i++){
         if(PD == PDArr[i].productdescription){
         PC = PDArr[i].prod;
         break;
         }
        }
        console.log('form data for building edit pcd descr');
        $("#updating").css("display", "block");
        try {
            google.script.run.withSuccessHandler(buildeditPCD).getEPCandFormdata(PC);
           $("#dropdown2").css("display", "none"); 
        } catch (e) {
            $("#updating").css("display", "none");
        }
    }
});

function getdatalists() {
    google.script.run.withSuccessHandler(buildPCPD).createDatalistPCPD();
}
var PCArr = [];
var PDArr = [];

function buildPCPD(data) {
    PCArr = data[0];
    PDArr = data[1];

}

function buildeditPCD(arr) {

    console.log('building edit pcd', arr);
    var data = arr[0];
    var EPC = arr[1];
    var EPD = arr[2];
    var which = arr[3];
 
    if (which == 'EPC') {
        if (EPD) {
            oldPCD = EPC;
            $("#EPD").val(EPD);

        } else {
            alert("Product Match not found!");
            $("#updating").css("display", "none");
            return;
        }
    } else {
        if (EPC) {
            oldPCD = EPD;

            $("#EPC").val(EPC);

        } else {
            alert("Product Match not found!");
            $("#updating").css("display", "none");
            return;
        }
    }
   $("#EPD").val(oldPCD.desc);
    $("#EPC").val(oldPCD.prod);
 
    var brandSelect = '<option selected value="' + oldPCD.brandSKU + '">' + oldPCD.brand + '<option>';
    var bottleSelect = '<option selected value="' + oldPCD.botSKU + '">' + oldPCD.btype + '<option>';
    
        var tubeSelect = '<option selected value="' + oldPCD.tubeSKU + '">' + oldPCD.tubeType + '<option>';

    var LidSelect = '<option selected value="' + oldPCD.lidSKU + '">' + oldPCD.lid + '<option>';
    var packagingSelect = '<option selected id="' + oldPCD.packagingType.sku + '" value="' + oldPCD.packagingType.sku + '">' + oldPCD.packagingType.name + '<option>';
    var boxSelect = '<option selected id="' + oldPCD.boxname.sku + '" value="' + oldPCD.boxname.sku + '">' + oldPCD.boxname.name + '<option>';

    var botlabelSelect = '<option selected  value="' + oldPCD.botlabelsku + '">' + oldPCD.botlabel + '<option>';
    var ppbotlabelSelect = '<option selected value="' + oldPCD.ppbotlabelsku + '">' + oldPCD.ppbotlabel + '<option>';

    var packlabelSelect = '<option selected value="' + oldPCD.packlabelsku + '">' + oldPCD.packlabel + '<option>';
    var pppacklabelSelect = '<option selected value="' + oldPCD.pppacklabelsku + '">' + oldPCD.pppacklabel + '<option>';


    for (var i = 0; i < data.brands.length; i++) {
        brandSelect += '<option value="' + data.brands[i].sku + '">' + data.brands[i].name + '<option>';
    }
    $("#editPCDbrand").html(brandSelect);

    for (var i = 0; i < data.bottletypes.length; i++) {
        bottleSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
    }
    $("#editPCDbottle").html(bottleSelect);
    
    for (var i = 0; i < data.bottletypes.length; i++) {
    tubeSelect += '<option value="' + data.bottletypes[i].sku + '">' + data.bottletypes[i].name + '<option>';
    }
    $("#editPCDtube").html(tubeSelect);

    for (var i = 0; i < data.lids.length; i++) {
        LidSelect += '<option value="' + data.lids[i].sku + '">' + data.lids[i].name + '<option>';
    }
    $("#editPCDcap").html(LidSelect);

    for (var i = 0; i < data.packagings.length; i++) {
        packagingSelect += '<option id="' + data.packagings[i].sku + '" value="' + data.packagings[i].sku + '">' + data.packagings[i].name + '<option>';
    }
    $("#editPCDpackaging").html(packagingSelect);

    for (var i = 0; i < data.boxes.length; i++) {
        boxSelect += '<option id="' + data.boxes[i].sku + '" value="' + data.boxes[i].sku + '">' + data.boxes[i].name + '<option>';
    }
    $("#editboxname").html(boxSelect);

    var labelsSelect = '';
    for (var i = 0; i < data.labels.length; i++) {
        labelsSelect += '<option id="' + data.labels[i].sku + '" value="' + data.labels[i].sku + '">' + data.labels[i].name + '<option>';
    }

    $("#editbotlabel").html(botlabelSelect + labelsSelect);
    $("#editppbotlabel").html(ppbotlabelSelect + labelsSelect);
    $("#editpacklabel").html(packlabelSelect + labelsSelect);
    $("#editpppacklabel").html(pppacklabelSelect + labelsSelect);




 
    
    
    
    


   if (oldPCD.usecomb) {
        $('#editUseComb').prop('checked', true);
    }
    
    $("#editfill").val(oldPCD.fill);
    $("#editCombMultiplier").val(oldPCD.multipliers.combs);
    $("#editBottleMultiplier").val(oldPCD.multipliers.bottles);

    $("#editpremixSKUSerum").val(oldPCD.premixSKUSerum);
    $("#editpremixdescrSerum").val(oldPCD.premixdescrSerum);
        $("#editpremixSKUStimulant").val(oldPCD.premixSKUStimulant);
    $("#editpremixdescrStimulant").val(oldPCD.premixdescrStimulant);
    $("#editprice").val(oldPCD.price);
    $("#updating").css("display", "none");

}
$('#delete_edit_PCD').on('click', function() {
    if (confirm('Are you sure you want to delete this product code from the database?')) {
        var productcode = $('#EPC').val();
        var productdescription = $('#EPD').val();

        google.script.run.withSuccessHandler(updateMachine).delete_PCD(productcode, productdescription);
     $("#editPCDmodal").modal("toggle");   
    }
});
$('#save_edit_PCD').on('click', function() {
    var productcode = $('#EPC').val();
    var productdescription = $('#EPD').val();
    var brandSKU = $('#editPCDbrand').val();
    var brandSelect = $('#editPCDbrand option:selected').text();
 
    var botSKU = $('#editPCDbottle').val();
    var bottleType = $('#editPCDbottle option:selected').text();
    var tubeSKU = $('#editPCDtube').val();
    var tubeType = $('#editPCDtube option:selected').text();

    var lidSKU = $('#editPCDcap').val();
    var lidType = $('#editPCDcap option:selected').text();

    var packagingTypesku = $('#editPCDpackaging').val();
    var packagingTypename = $('#editPCDpackaging option:selected').text();

    var object = {
        botlabel: $('#editbotlabel option:selected').text(),
        botlabelsku: $('#editbotlabel').val(),
        ppbotlabel: $('#editppbotlabel option:selected').text(),
        ppbotlabelsku: $('#editppbotlabel').val(),

        packlabel: $('#editpacklabel option:selected').text(),
        packlabelsku: $('#editpacklabel').val(),
        pppacklabel: $('#editpppacklabel option:selected').text(),
        pppacklabelsku: $('#editpppacklabel').val(),
        price: $('#editprice').val(),
        fill: parseInt($('#editfill').val(), 10),
        boxname: {
            sku: $('#editboxname').val(),
            name: $('#editboxname option:selected').text(),
        },
        premixSKUSerum: $('#editpremixSKUSerum').val(),
        premixdescrSerum: $('#editpremixdescrSerum').val(),
        premixSKUStimulant: $('#editpremixSKUStimulant').val(),
        premixdescrStimulant: $('#editpremixdescrStimulant').val(),
        unbrandSKU: $('#editunbrandSKU').val(),
        unbranddescr: $('#editunbranddescr').val(),
        productcode: productcode,
        productdescription: productdescription,
        multipliers:{
        combs:$('#editCombMultiplier').val() ? parseInt($('#editCombMultiplier').val(),10) : 1,
        bottles:$('#editBottleMultiplier').val() ? parseInt($('#editBottleMultiplier').val(),10) : 1,
        },
        brand: brandSelect,
        brandSKU: brandSKU,
        usecomb: $('#editUseComb').is(":checked"),
        btype: bottleType,
        botSKU: botSKU,
        lidSKU: lidSKU,
        lid: lidType,

        packagingType: {
            sku: '',
            name: '',
        }, 
    };
 

    object.packagingType.sku = packagingTypesku;

    object.packagingType.name = packagingTypename;

   
    console.log('EPC', object);
    google.script.run.withSuccessHandler(updateMachine).save_PCD(object, oldPCD, true);
});

//INVENTORY

$('#newitem').on('click', function(e) {

    google.script.run.withSuccessHandler(buildItemForm).getInventoryDescription();
});

var INPDATA;

function buildItemForm(data) {
    INPDATA = data;

}

function removeFromInventory(item, page) {
    console.log(item);
    google.script.run.withSuccessHandler(InventoryItemSuccess).removefromInventory(item, page);

}

function insertToQTY(item, page) {

    google.script.run.withSuccessHandler(InventoryItemSuccess).addtoQTY(item, page);

}

function InventoryItemSuccess(msg) {
    alert(msg);
    // google.script.run.withSuccessHandler(buildInventory).getInventoryData();
    filterpage('xx', true);
}

function editItem(item, page) {
    google.script.run.withSuccessHandler(buildItemFormFromExisting).getItemData(item, page);
}

function buildItemFormFromExisting(retval) {
    console.log(retval);
    INPDATA = retval[0];
    var dataold = retval[1];

    $('#description').val(dataold.desc);
    $('#description2').val(dataold.key);
    $('#orderDate1').val(formatDateInput(dataold.orderdate));
    $('#paiddate').val(formatDateInput(dataold.paiddate));
    $('#deliveryDate').val(formatDateInput(dataold.delivdate));
    $('#eta').val(dataold.eta);
    $('#quantity').val(dataold.quantity);
    $('#note').val(dataold.note);
    $("#descriptionsku").val(dataold.sku);
    $("#descriptionpage").val(dataold.page);

}

//EDIT PCD

var input3 = document.getElementById('description');

var optionsVal3 = document.getElementById('list4');

input3.addEventListener('keyup', show4);

RegExp.escape = function(s) {
    return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
};

function show4() {
    if (this.keyCode == 13) {
        return false;
    }
    //document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById('dropdown4');
    dropdown.style.display = 'none';

    optionsVal3.options.length = 0;

    if (input3.value) {
        dropdown.style.display = 'block';
        optionsVal3.size = 3;
        var textCountry = input3.value;

        for (var i = 0; i < INPDATA.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (INPDATA[i].name) {
                if (INPDATA[i].name.match(testableRegExp)) {

                    addValue4(INPDATA[i].name, INPDATA[i].name, INPDATA[i].sku, INPDATA[i].page, INPDATA[i].key);

                }
            }
        }

        var size = dropdown.children[0].children;
        if (size.length > 0) {
            var defaultSize = 16;
            if (size.length < 10) {
                defaultSize *= size.length;
            } else {
                defaultSize *= 10;
            }
            dropdown.children[0].style.height = defaultSize + "px";
        }

    }
}

function addValue4(text, val, sku, page, key) {
    //console.log('here');
    var createOptions = document.createElement('option');
    optionsVal3.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
    createOptions.setAttribute('sku', sku);
    createOptions.setAttribute('key', key);
    createOptions.setAttribute('page', page);
}

//Settin the value in the box by firing the click event
function setVal4(selectedVal) {
    $('#description').val($(selectedVal).val());

    console.log(selectedVal.options[selectedVal.selectedIndex].getAttribute('page'), selectedVal.options[selectedVal.selectedIndex].getAttribute('sku'))
    $('#descriptionsku').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('sku'));
    $('#descriptionpage').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('page'));
    $('#description2').val(selectedVal.options[selectedVal.selectedIndex].getAttribute('key'));

    document.getElementById('dropdown4').style.display = 'none';
}

$("#custManage").on('click', function() {

    $("#managePage").html("");
    google.script.run.withSuccessHandler(populateCustomers).getCustomerList();

});

function populateCustomers(list) {
    var html = '';
    html = '<table class="table"><thead>';
    html += '<tr><th>SKU</th><th>Name</th><th>Address</th><th>Action</th></tr></thead><tbody>';
    for (var i = 0; i < list.length; i++) {

        html += "<tr><td>" + list[i].sku + "</td><td>" + list[i].name + "</td><td>" + list[i].address + "</td><td><button  class='btn btn-primary'  id='" + list[i].sku + "' onclick='editCustomer(this)' >Edit</button></td></tr>"
    }
    html += '</tbody></table>'

    $("#managePage").html(html);
}

function editCustomer(event) {
    var name = $(event).attr('id');
    google.script.run.withSuccessHandler(getSingleCustomer).getCust(name);

}
var oldCUST = {};

function getSingleCustomer(data) {
    oldCUST = data;
    $("#editCustomerDiv").show();
    $("#editSKU").val(data.sku);
    $("#editName").val(data.name);
    $("#addressEdit").val(data.address);
    $("#addressEdit").focus();

}

$("#saveCustEdit").on('click', function() {
    var obj = {
        name: $("#editName").val(),
        address: $("#addressEdit").val(),
        sku: oldCUST.sku,
    }
    console.log(obj);
    google.script.run.withSuccessHandler(editCustSuccess).newBasicItem(obj, 'Customers');
    oldCUST = {};
});

function editCustSuccess(msg) {
    $("#editCustomerDiv").hide();
    alert(msg);
    google.script.run.withSuccessHandler(populateCustomers).getCustomerList();

}

function moveItems(origin, dest) {
    var child = $(origin).find(':selected');
    $(origin).find(':selected').appendTo(dest);

}

function moveAllItems(origin, dest) {
    var childs = $(origin).children();
    $(origin).children().appendTo(dest);
    console.log(childs);

}

var SHIPPING_NOTE = false;
var xero_NOTE = false;
var statusCheck = false;
$('#getShippingCodes').click(function() {
    SHIPPING_NOTE = true;
    xero_NOTE = false;
    statusCheck = false;
    google.script.run.withSuccessHandler(populatePackCodes).getPackCodes();

});

$('#getOrderIDs').click(function() {
    SHIPPING_NOTE = false;
    statusCheck = false;
    xero_NOTE = true;
    google.script.run.withSuccessHandler(populateOrderIDs).getOrderIDs('xero');

});
$('#getOrderIDs2').click(function() {
    statusCheck = true;
    SHIPPING_NOTE = false;
    xero_NOTE = false;
    google.script.run.withSuccessHandler(populateOrderIDs).getOrderIDs('xero');

});

function populatePackCodes(list) {
    //console.log(list);
    var html = '';
    for (var i = 0; i < list.length; i++) {
        html += '<option value="' + list[i] + '">' + list[i] + '</option>';
    }
    //console.log(html);
    $('#sbOne').html(html);
}

function populateOrderIDs(list) {

    //console.log(list);
    var html = '';
    for (var i = 0; i < list.length; i++) {
        html += '<option  date="' + list[i][0] + '" value="' + list[i][1] + '">' + formatDateDisplay(list[i][0]) + ' ' + list[i][1] + ' ' + list[i][3] + '</option>';
    }
    //console.log(html);
    if (statusCheck) {

        $('#statusOne').html(html);
    } else {
        $('#xrOne').html(html);
    }
    //console.log('orderIDsDATATop',orderIDsDATATop)
}

$('#printShipping').click(function() {
    var arr = [];
    var myOpts = document.getElementById('sbTwo').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }
    if (arr.length > 0) {
        google.script.run.withSuccessHandler(stockCheck).printShippingNote(arr, 1);
    } else {
        alert('No codes selected.');
    }
    $('#sbTwo').html('');
});
$('#printShipping2').click(function() {
    var arr = [];
    var myOpts = document.getElementById('sbTwo').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }
    if (arr.length > 0) {
        google.script.run.withSuccessHandler(stockCheck).printShippingNote(arr, 2);
    } else {
        alert('No codes selected.');
    }
    $('#sbTwo').html('');
});

$('#printxero').click(function() {
    var arr = [];
    var myOpts = document.getElementById('xrTwo').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }
    if (arr.length > 0) {
        google.script.run.withSuccessHandler(stockCheck).printxero(arr);
    } else {
        alert('No codes selected.');
    }
    $('#xrTwo').html('');
});
$('#statuscheck').click(function() {
    var arr = [];
    var myOpts = document.getElementById('statusTwo').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }
    if (arr.length > 0) {
        $("#updating").css("display", "block");
        console.log(arr);
        google.script.run.withSuccessHandler(buildhtmlmodal).checkStatus(arr);

    } else {
        alert('No codes selected.');
    }
    $("statusTwo").html('');
});
$('.left').click(function() {
    if (SHIPPING_NOTE) {
        moveItems('#sbTwo', '#sbOne');
    } else if (xero_NOTE) {
        moveItems('#xrTwo', '#xrOne');
    } else {
        moveItems('#statusTwo', '#statusOne');
    }
});

$('.right').on('click', function() {

    if (SHIPPING_NOTE) {
        moveItems('#sbOne', '#sbTwo');
    } else if (xero_NOTE) {
        moveItems('#xrOne', '#xrTwo');
    } else {
        moveItems('#statusOne', '#statusTwo');
    }
});

$('.leftall').on('click', function() {

    if (SHIPPING_NOTE) {
        moveAllItems('#sbTwo', '#sbOne');
    } else if (xero_NOTE) {
        moveAllItems('#xrTwo', '#xrOne');
    } else {
        moveAllItems('#statusTwo', '#statusOne');
    }
});

$('.rightall').on('click', function() {

    if (SHIPPING_NOTE) {
        moveAllItems('#sbOne', '#sbTwo');
    } else if (xero_NOTE) {

        moveAllItems('#xrOne', '#xrTwo');
    } else {
        moveAllItems('#statusOne', '#statusTwo');
    }
});

function getIndex2(searchValue, array) {
    for (var i = 0; i < array.length; i++) {
        if (array[i][1] == searchValue) {
            return i
            break;
        }

    }
    return -1;

}

function getOrderIDsTop() {
    var childs = $('#xrOne').children();
    var ret = [];
    for (var i = 0; i < childs.length; i++) {
        ret.push([$(childs[i]).attr('date'), $(childs[i]).val()])
    }
    console.log('ret', ret);
    return ret;
}

function getOrderIDsPrioriies() {
    var childs = $('.priorityBody').children();
    var ret = [];
    for (var i = 0; i < childs.length; i++) {
        console.log(childs[i]);
        ret.push([$(childs[i]).attr('date'), $(childs[i]).attr('orderID'), $(childs[i]).attr('priority')])
    }
    console.log('ret', ret);
    return ret;
}

function filterxero(event) {
    var modal = $(event).attr('page');

    var dates = {

        'startDate': $('#' + modal + ' #startSearchOrderIDs').val(),
        'endDate': $('#' + modal + ' #endSearchOrderIDs').val(),
        'keyword': $('#' + modal + ' #keyword').val(),
    };
    if (modal == 'xeroModal') {
        var data = getOrderIDsTop();
    } else if (modal == 'statusModal') {
        var data = getOrderIDsTop();
    } else {
        var data = getOrderIDsPrioriies();
    }
    if (dates.startDate) {
        var start = new Date(dates.startDate);
    } else {

        var start = new Date('01-01-1970');
    }
    if (dates.endDate) {
        var end = new Date(dates.endDate);
    } else {

        var end = new Date('01-01-2040');
    }
    var ret = [];
    console.log('start', start);
    for (var i = 0; i < data.length; i++) {

        var arrtime = parseInt(data[i][0], 10);

        if (start.getTime() <= arrtime && end.getTime() >= arrtime) {
            if (dates.keyword == '') {
                ret.push(data[i]);
            } else {
                if (JSON.stringify(data[i]).toLowerCase().match(dates.keyword.toLowerCase())) {
                    ret.push(data[i]);
                }
            }

        } else {
            //  console.log('logitem',arrtime);
            //   console.log('start',start);
        }

    }
    if (modal == 'xeroModal') {
        var childs = $('#xrOne').children();
        for (var i = 0; i < childs.length; i++) {
            $(childs[i]).hide();
        }
        for (var i = 0; i < childs.length; i++) {
            for (var j = 0; j < ret.length; j++) {
                if ($(childs[i]).val() == ret[j][1]) {
                    $(childs[i]).show();
                    break;
                }
            }
        }
    } else if (modal == 'statusModal') {
        var childs = $('#statusOne').children();
        for (var i = 0; i < childs.length; i++) {
            $(childs[i]).hide();
        }
        for (var i = 0; i < childs.length; i++) {
            for (var j = 0; j < ret.length; j++) {
                if ($(childs[i]).val() == ret[j][1]) {
                    $(childs[i]).show();
                    break;
                }
            }
        }
    } else {

        var childs = $('.priorityBody').children();
        for (var i = 0; i < childs.length; i++) {
            $(childs[i]).hide();
        }
        for (var i = 0; i < childs.length; i++) {
            for (var j = 0; j < ret.length; j++) {
                if ($(childs[i]).attr('id') == ret[j][1]) {
                    $(childs[i]).show();
                    break;
                }
            }
        }

    }
    //return ret;
}

var MAXSEARCHNUM = 5;

function getSearchBoxData(page) {
    SEARCHNUM = 0;
    $('.searchBox' + page).html('');
    google.script.run.withSuccessHandler(populateSearchBox).getSearchBoxKeys(page);

}

function addSearchOption(event) {
    var page = $(event).attr('page');

    $(event).remove();

    console.log('here');
    console.log(page);
    if (SEARCHNUM < MAXSEARCHNUM) {
        $('#pageSearch' + page).remove();
        SEARCHNUM++;
        google.script.run.withSuccessHandler(populateSearchBox).getSearchBoxKeys(page);

    } else {

    }
}

function populateSearchBox(rett) {
    //console.log(rett);
    var data = rett[0];
    var page = rett[1];
    var html = '<div class="searchItem" id="searchItem' + SEARCHNUM + page + '"';

    html += '<table class="form_table">';
    html += '<thead><tr><th>Search By:</th><tr></thead><tbody>';
    html += '<tr><td><select class="form-control"  page="' + page + '" id="sarchKey' + page + SEARCHNUM + '" num="' + SEARCHNUM + '" onchange="getSearchValues(this);">';

    var keySELECT = '<option value=""><option>';
    for (var i = 0; i < data.length; i++) {
        keySELECT += '<option key="' + data[i][2] + '" value="' + data[i][0] + '">' + data[i][1] + '<option>';
    }
    html += keySELECT;
    html += ' </select></td></tr></tbody></table>';
    html += '</div>';

    $('.searchBox' + page).append(html);
}

function getSearchValues(event) {
    console.log('here');
    var page = $(event).attr('page');
    var num = $(event).attr('num');
    var DBpage = $('#sarchKey' + page + num).val();
    var key = $('option:selected', event).attr('key');
    console.log(page, DBpage, key);
    if (DBpage) {

        google.script.run.withSuccessHandler(populateSearchValues).getSearchValues(page, DBpage, key, num);
    }
}

function populateSearchValues(data) {
    console.log(data);
    var page = data[0];
    var list = data[1];
    var key = data[2];
    var num = data[3];
    $('#searchVALDIV' + page + num).remove();

    if (key == 'word' || key == 'priority') {
        var html = '<input class="form-control" id="searchVAL' + page + num + '" num="' + num + '" type="text"/>';

    } else {
        var html = '<select  class="form-control" id="searchVAL' + page + num + '" num="' + num + '">';
        for (var i = 0; i < list.length; i++) {
            if (list[i].name) {
                html += '<option value="' + list[i].name + '">' + list[i].name + '</option>';
            }
        }
        html += '</select>';

    }
    if (num == SEARCHNUM) {
        var button = '<button class="btn btn-primary" id="pageSearch' + page + '" page="' + page + '" onclick="filterpage(this);">Search</button>';
        var button2 = '<button class="btn btn-default" id="addSearchOption" page="' + page + '" onclick="addSearchOption(this);">+</button>';
    } else {
        var button = '';
        var button2 = '';
    }

    var table = '<table><thead><tr><th>Value</th><th></th><th></th></tr></thead>';
    table += '<tbody><tr><td>' + html + '</td><td>' + button2 + '</td><td>' + button + '</td></tr></tbody>';
    var div = "<div id='searchVALDIV" + page + num + "'>" + table + "</div>";
    $('#searchItem' + num + page).append(div);
}

var LASTSEARCH;

function filterpage(event, skip) {
    var searchItems = [];
    if (!skip) {
        for (var i = 0; i <= SEARCHNUM; i++) {
            var page = event.getAttribute('page');
            var val = $('#searchVAL' + page + i).val();
            var key = $('option:selected', '#sarchKey' + page + i).attr('key');
            var params = {
                orderBy: key,
                equalTo: val

            };
            if (key) {
                searchItems.push([page, params]);
            }
        }
    }
    if (selPage == 'Inventory' && searchItems.length == 0) {

        searchItems.push([selPage, {
            equalTo: 'all'
        }]);
    } else if (selPage != 'Inventory') {
        searchItems.push([selPage, BASEPARAM]);
    }

    LASTSEARCH = searchItems;
    console.log(searchItems);

    google.script.run.withSuccessHandler(filterResult).searchFor(searchItems);
pagesSplit = false;
}

function moveUp(e) {

    var currentBatch = $(e).attr('batch');
    var currentPage = $(e).attr('page');

    google.script.run.withSuccessHandler(movefunc).moveUp(currentPage, currentBatch);
}

function movefunc(data) {

    filterpage('xx', true);
}

function moveDown(e) {
    var currentBatch = $(e).attr('batch');
    var currentPage = $(e).attr('page');

    google.script.run.withSuccessHandler(movefunc).moveDown(currentPage, currentBatch);
}

//LOGSTATUS

google.script.run.withSuccessHandler(setStatus).getStatus();

$('#LOGstatus').on('click', function() {
    var attr = $('#LOGstatusID').val();
    google.script.run.withSuccessHandler(setStatus).setStatusinDB(attr);
});

function setStatus(resp) {
    if (resp) {
        $('#LOGstatus').html('Log On');
        $('#LOGstatusID').val('On');
    } else {
        console.log('here');
        $('#LOGstatus').html('Log Off');
        $('#LOGstatusID').val('Off');
    }

}

function datesearch() {

    google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);

}

$('#startSearch').change(function() {

    google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);
})
$('#endSearch').change(function() {

    google.script.run.withSuccessHandler(filterResult).searchFor(LASTSEARCH);
})

var EDIT_RECIPE_CONST = false;
$('#editRecipeButton').on('click', function() {
    EDIT_RECIPE_CONST = true;
    $('.newRecipeBody').hide();
    $('.editRecipeBody').show();
    $("#delete_edit_recipe").show();
    google.script.run.withSuccessHandler(set_colors_helper_dropdown).get_colors_helper_dropdown();
    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editRecipeButton');
});

$('#newRecipeButton').on('click', function() {
    $('.newRecipeBody').show();
    $('.editRecipeBody').hide();
    $("#delete_edit_recipe").hide();

    EDIT_RECIPE_CONST = false;
    google.script.run.withSuccessHandler(set_colors_helper_dropdown).get_colors_helper_dropdown();

})

function set_colors_helper_dropdown(data) {
    var html = "<option value=''></option>";
    for (var i = 0; i < data.length; i++) {
        html += '<option value="' + data[i].sku + '">' + data[i].name + '</option>';

    }
    if (EDIT_RECIPE_CONST) {
        $('#ecolorSelect').html(html);
    } else {

        $('#colorSelect').html(html);
    }
}

var EDIT_PACKAGING_CONST = false;
$('#editPackageButton').on('click', function() {
    EDIT_PACKAGING_CONST = true;
    $('.newPackagingBody').hide();
    $('.editPackagingBody').show();
    $("#delete_edit_packaging").show();
    //  google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();

    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editPackageButton');

});

var EDIT_BOX_CONST = false;
$('#editBoxButton').on('click', function() {
    EDIT_BOX_CONST = true;
    $('.newBoxBody').hide();
    $('.editBoxBody').show();
    $("#delete_edit_box").show();

    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editBoxButton');

});
$('#newBoxButton').on('click', function() {
    $('.newBoxBody').show();
    $('.editBoxBody').hide();
    $("#delete_edit_box").hide();

    EDIT_BOX_CONST = false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();

});

var EDIT_LABEL_CONST = false;
$('#editLabelButton').on('click', function() {
    EDIT_LABEL_CONST = true;
    $('.newLabelBody').hide();
    $('.editLabelBody').show();
    $("#delete_edit_Label").show();

    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editLabelButton');

});
$('#newLabelButton').on('click', function() {
    $('.newLabelBody').show();
    $('.editLabelBody').hide();
    $("#delete_edit_Label").hide();

    EDIT_LABEL_CONST = false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();

});

var EDIT_COLOR_CONST = false;
$('#editColorButton').on('click', function() {
    EDIT_COLOR_CONST = true;
    $('.newColorBody').hide();
    $('.editColorBody').show();
    $("#delete_edit_Color").show();

    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editColorButton');

});
$('#newColorButton').on('click', function() {
    $('.newColorBody').show();
    $('.editColorBody').hide();
    $("#delete_edit_Color").hide();

    EDIT_COLOR_CONST = false;
    //google.script.run.withSuccessHandler(set_packages_helper_dropdown).get_packages_helper_dropdown();

});

//GLOBAL DROPDOWN SUGGESTER
var ACTIVEARRAYS = [];

function set_active_dropdown_arrays(data) {
    console.log('data', data);
    ACTIVEARRAYS = [];
    data.map(function(item) {
        ACTIVEARRAYS.push(item);
    })

    createSUGGESTER();
}

var SUGGESTARR = [];
var INPUTARR = [];
var SELECTARR = [];

function createSUGGESTER() {
    INPUTARR = [];
    SUGGESTARR = [];
    SELECTARR = [];
    for (var i = 0; i < ACTIVEARRAYS.length; i++) {
        // INPUT , DIV OVER SELECT , SELECT  , ARRAY, PAGE
        SUGGESTARR.push([document.getElementById(ACTIVEARRAYS[i][0]), ACTIVEARRAYS[i][1], document.getElementById(ACTIVEARRAYS[i][2]), ACTIVEARRAYS[i][3], ACTIVEARRAYS[i][4]]);
        INPUTARR.push(ACTIVEARRAYS[i][0]);
        SELECTARR.push(ACTIVEARRAYS[i][2]);
    }

}

//<input type="text" onkeyup="showGLOBAL(this)">  <select onclick='helperSETVAL(this)'
function helperSETVAL(event) {
    var id = $(event).attr('id');
    var index = SELECTARR.indexOf(id);
    var drop = SUGGESTARR[index][1];
    var inp = SUGGESTARR[index][0];
    var page = SUGGESTARR[index][4];
    setValGLOBAL(event, drop, inp, page);

}

RegExp.escape = function(s) {

    s = s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replace("\\{", "\\$&").replace("\\}", "\\$&");

    return s;
};

function showGLOBAL(event) {

    var id = $(event).attr('id');
    console.log(id);
    var index = INPUTARR.indexOf(id);
    console.log(index);
    var inp = SUGGESTARR[index][0];
    var drop = SUGGESTARR[index][1];
    var opt = SUGGESTARR[index][2];
    var arr = SUGGESTARR[index][3];
    console.log(drop);
    //document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById(drop);
    dropdown.style.display = 'none';
    //$("#"+drop).html('');
    opt.options.length = 0;

    if (inp.value) {
        dropdown.style.display = 'block';
        opt.size = 3;
        var textCountry = inp.value;

        for (var i = 0; i < arr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");

            if (typeof arr[i] === 'array') {
                var searchin = RegExp.escape(arr[i].toString());
            } else if (typeof arr[i] === 'object') {
                var searchin = RegExp.escape(JSON.stringify(arr[i]));
            } else {
                var searchin = RegExp.escape(arr[i].toString());
            }
            console.log('arr[i]', searchin, 'text', testableRegExp);

            if (searchin.match(testableRegExp)) {
                addValueGLOBAL(arr[i], opt, id);

            }
        }

        var size = dropdown.children[0].children;
        if (size.length > 0) {
            var defaultSize = 16;
            if (size.length < 10) {
                defaultSize *= size.length;
            } else {
                defaultSize *= 10;
            }
            dropdown.children[0].style.height = defaultSize + "px";
        }

    }
}

function addValueGLOBAL(ARR, option, id) {
    var createOptions = document.createElement('option');
    var text, value;
    option.appendChild(createOptions);
    switch (id) {
        case 'erecipeCODE':
            text = ARR[1];
            value = ARR[1];
            createOptions.setAttribute('key', ARR[1]);

            break;
        case 'erecipeName':
            text = ARR[0];
            value = ARR[0];
            createOptions.setAttribute('key', ARR[1]);

            break;
        case 'epackagingName':
            text = ARR.name;
            value = ARR.name;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'epackagingSKU':
            text = ARR.sku;
            value = ARR.sku;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eboxName':
            text = ARR.name;
            value = ARR.name;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eboxSKU':
            text = ARR.sku;
            value = ARR.sku;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eLabelName':
            text = ARR.name;
            value = ARR.name;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eLabelSKU':
            text = ARR.sku;
            value = ARR.sku;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eColorName':
            text = ARR.name;
            value = ARR.name;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eColorSKU':
            text = ARR.sku;
            value = ARR.sku;
            createOptions.setAttribute('key', ARR.sku);

            break;

        case 'eflavourmixName':
            text = ARR.name;
            value = ARR.name;
            createOptions.setAttribute('key', ARR.sku);

            break;
        case 'eflavourmixSKU':
            text = ARR.sku;
            value = ARR.sku;
            createOptions.setAttribute('key', ARR.sku);

            break;
        default:
            text = '';
            value = '';
    }

    createOptions.text = text;
    createOptions.value = value;

    //  createOptions.setAttribute('id',sku);
}

//Settin the value in the box by firing the click event
function setValGLOBAL(selectedVal, dropdown, inp, page) {

    inp.value = selectedVal.value;
    document.getElementById(dropdown).style.display = 'none';

    var key = $('option:selected', selectedVal).attr('key');
    console.log('key', key);
    console.log('page', page);
    google.script.run.withSuccessHandler(set_remaining_data).get_remaining_data(page, key);

}

var OLDITEM = {};

function set_remaining_data(data) {
    var item = data[0];
    var page = data[1];
    OLDITEM = item;
    switch (page) {
        case 'Recipes':
            $('#erecipeCODE').val(item.id);
            $('#erecipeName').val(item.name);
            $('#erecipeVG').val(item.VGrec);
            $('#erecipePG').val(item.PGrec);
            $('#erecipeCBD').val(item.cbdrec);
            $('#erecipeMCT').val(item.MCTrecipe);
            $('#erecipeAG').val(item.AGrec);

            $('#erecipevgval').val(item.vg);
            $('#erecipepgval').val(item.pg);
            $('#erecipestrength').val(item.strength);

            $('#erecipeNicotine').val(item.Nicorec);
            $('#erecipeNicotineSalts').val(item.Nicorecsalts);
            $('#erecipeFlavour').val(item.Flavrec);
            $('#ecolorSelect').val(item.Color.sku);
            $('#ecolorpercentage').val(item.Color.val);
            break;

        case 'Packages':
            $('#epackagingSKU').val(item.sku);
            $('#epackagingName').val(item.name);
            $('#ebotperPack').val(item.botperPack);
            $('#eink').val(item.ink);
            // $("select[name='etubelabel']").find("option[value='"+item.tubelabel.sku+"']").attr("selected",true);
            break;

        case 'Boxes':
            $('#eboxSKU').val(item.sku);
            $('#eboxName').val(item.name);
            $('#edivTubesForBox').val(item.divTubesForBox);

            break;
        case 'Labels':
            $('#eLabelSKU').val(item.sku);
            $('#eLabelName').val(item.name);

            break;
        case 'Color':
            $('#eColorSKU').val(item.sku);
            $('#eColorName').val(item.name);

            break;
        case 'FlavourMixes':
            $(".editflavourmixBody #eflavourmixName").val(item.name);
            $(".editflavourmixBody #eflavourmixSKU").val(item.sku);
            createDropdownsForItem(item);

            break;
        default:
            break;
    }

}

$("#delete_edit_recipe").on('click', function() {
    if (confirm('Are you sure you want to delete this recipe?')) {
        var key = $('#erecipeCODE').val();
        google.script.run.withSuccessHandler(alert_deletion).remove_recipe(key);
        $('#erecipeCODE').val('');
        $('#erecipeName').val('');
        $('#erecipeVG').val('');
        $('#erecipePG').val('');
        $('#erecipeCBD').val('');

        $('erecipevgval').val('');
        $('erecipepgval').val('');
        $('erecipestrength').val('');

        $('#erecipeNicotine').val('');
        $('#erecipeNicotineSalts').val('');
        $('#erecipeFlavour').val('');
        $('#ecolorSelect').html('');
        $('#ecolorpercentage').val('');
        $('#newRecipe').modal('toggle');

    }
});

$("#delete_edit_packaging").on('click', function() {
    if (confirm('Are you sure you want to delete this packaging?')) {
        var key = $('#epackagingSKU').val();
        google.script.run.withSuccessHandler(alert_deletion).remove_packaging(key);
        $('#epackagingSKU').val('');
        $('#epackagingName').val('');
        $('#ebotperPack').val('');
        $('#eink').val('');
        //$("select[name='etubelabel']").find("option[value='']").attr("selected",true);
        $('#newPackaging').modal('toggle');

    }
});

$("#delete_edit_box").on('click', function() {
    if (confirm('Are you sure you want to delete this box?')) {
        var key = $('#eboxSKU').val();
        google.script.run.withSuccessHandler(alert_deletion).remove_box(key);
        $('#eboxSKU').val('');
        $('#eboxName').val('');
        $('#edivTubesForBox').val('');
        $('#newBox').modal('toggle');
    }
});

$("#delete_edit_Label").on('click', function() {
    if (confirm('Are you sure you want to delete this box?')) {
        var key = $('#eLabelSKU').val();
        google.script.run.withSuccessHandler(alert_deletion).remove_Label(key);
        $('#eLabelSKU').val('');
        $('#eLabelName').val('');

        $('#newLabel').modal('toggle');
    }
});

$("#delete_edit_Color").on('click', function() {
    if (confirm('Are you sure you want to delete this box?')) {
        var key = $('#eColorSKU').val();
        google.script.run.withSuccessHandler(alert_deletion).remove_item(key, 'Color');
        $('#eColorSKU').val('');
        $('#eColorName').val('');

        $('#newColor').modal('toggle');
    }
});

$("#newflavourmixButton").on('click', function() {
    flavournum = 0;
    EDIT_FLAVMIX_CONST = false;
    $(".newflavourmixBody #flavourDropdowns").html('');
    $(".newflavourmixBody #flavourmixName").val('');
    $(".newflavourmixBody #flavourmixSKU").val('');
    $(".newflavourmixBody #flavourmixPlusButton").show();
    $(".newflavourmixBody #flavourmixMinusButton").show();
    $(".newflavourmixBody").show();

    $(".editflavourmixBody").hide();
    $("#deleteflavourmixButton").hide();
    renderBottle();
    google.script.run.withSuccessHandler(createFlavourDropdown).getFlavourDropdown();
});

$("#editflavourmixButton").on('click', function() {
    EDIT_FLAVMIX_CONST = true;
    $(".editflavourmixBody #flavourDropdowns").html('');
    $(".editflavourmixBody #flavourmixName").val('');
    $(".editflavourmixBody #flavourmixSKU").val('');
    $(".editflavourmixBody #flavourmixPlusButton").show();
    $(".editflavourmixBody #flavourmixMinusButton").show();
    $(".editflavourmixBody").show();

    $(".newflavourmixBody").hide();
    $("#deleteflavourmixButton").show();
    renderBottle();
    google.script.run.withSuccessHandler(createFlavourDropdown).getFlavourDropdown();

    google.script.run.withSuccessHandler(set_active_dropdown_arrays).get_active_dropdown_arrays('editflavourmixButton');

});
$("#deleteflavourmixButton").on('click', function() {
    var key = $('#eflavourmixSKU').val();
    google.script.run.withSuccessHandler(alert_deletion).remove_flavourmix(key);
    $('#eflavourmixSKU').val('');
    $('#eflavourmixName').val('');
    $(".editflavourmixBody #flavourDropdowns").html('');
    $('#newflavourmix').modal('toggle');

});
var EDIT_FLAVMIX_CONST = false;
var FLAVOURDROPDOWN = '';
var flavournum = 0;

function createFlavourDropdown(data) {

    FLAVOURDROPDOWN = '';
    var html = '';
    for (var i = 0; i < data.length; i++) {
        html += '<option value="' + data[i].sku + '" id="' + data[i].sku + '">' + data[i].name + '<option>';
    }
    FLAVOURDROPDOWN = html;

}

$(".newflavourmixBody #flavourmixPlusButton").on('click', function() {
    flavournum++;
    var spec = '';
    var spec2 = '';
    NEWFLAVOURSINFLAVOURMIX = [];
    if (EDIT_FLAVMIX_CONST) {
        spec = 'e';
    } else {
        spec2 = '<option value="New Flavour" >New Flavour<option>';
    }
    var colorsARR = ['black', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#800000', '#808000', '#008000', '#008080', ];
    var selector = '<div class="flavourBlock" id="' + spec + 'flavourBlockID' + flavournum + '"><input type="text" class="form-control"  style="width:150px;display:inline-block; border:2px solid ' + colorsARR[flavournum] + '; " id="' + spec + 'flavourAmount' + flavournum + '" oninput="renderBottle()" placeholder="2"/>';
    selector += '<select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="' + spec + 'flavourSelect' + flavournum + '" onchange="checkifNewFlavourFlavourMixer(this)"   spec="' + spec + '"  flavournum="' + flavournum + '"  >' + FLAVOURDROPDOWN + spec2 + '</select>';
    selector += '<input  class="form-control"   style="display:none; width: 200px;" id="' + spec + 'flavourSelectSKU' + flavournum + '" placeholder="SKU" /><input  class="form-control"   style="display:none; width: 200px;" id="' + spec + 'flavourSelectNAME' + flavournum + '"  placeholder="Name" /></div>';

    console.log('flavournum', flavournum)
    $(".newflavourmixBody #" + spec + "flavourDropdowns").prepend(selector);
});
var NEWFLAVOURSINFLAVOURMIX = [];

function checkifNewFlavourFlavourMixer(event) {
    var value = $(event).val();
    if (value == 'New Flavour') {
        var spec = $(event).attr('spec');
        var flavournum = $(event).attr('flavournum');
        $(event).hide();
        $('#' + spec + 'flavourSelectSKU' + flavournum).show().css('display', 'inline-block');
        $('#' + spec + 'flavourSelectNAME' + flavournum).show().css('display', 'inline-block');
        NEWFLAVOURSINFLAVOURMIX.push(flavournum);
        console.log(NEWFLAVOURSINFLAVOURMIX);
    }
}
$(".newflavourmixBody #flavourmixMinusButton").on('click', function() {
    var spec = '';
    if (EDIT_FLAVMIX_CONST) {
        spec = 'e';
    }
    $(".newflavourmixBody #flavourDropdowns #" + spec + "flavourBlockID" + flavournum).remove();
    if (flavournum != 0) {
        flavournum--;
    }
    console.log('flavournum', flavournum)
});

function renderBottle() {
    console.log('rendering');

    var colorsARR = ['black', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#800000', '#808000', '#008000', '#008080', ];
    var total = 0;
    var special = '';
    var special2 = '';
    if (EDIT_FLAVMIX_CONST) {
        special2 = '.editflavourmixBody #';
        special = '.editflavourmixBody #e';
    } else {
        special = '.newflavourmixBody #';
        special2 = '.newflavourmixBody #';
    }
    for (var i = 1; i <= 10; i++) {
        $(special2 + "bottleBlock" + i).css('background-color', 'white');
    }
    var vals = [];
    for (var i = 1; i <= flavournum; i++) {
        var val = parseInt($(special + 'flavourAmount' + i).val(), 10);
        vals.push(val);
        for (var j = total + 1; j <= val + total; j++) {
            console.log('setting color for', j);
            $(special2 + "bottleBlock" + j).css('background-color', colorsARR[i]);
        }
        total += val;
        if (total > 10) {
            alert('Warning! Mix will exceed the 10ml limit.');
        }
    }
    var html = '';
    var totalHTML = '';
    if (total == 10) {
        totalHTML = '<span style="color:green;">' + total + '</span>';
    } else {
        totalHTML = '<span style="color:red;">' + total + '</span>';
    }
    for (var i = 0; i < vals.length; i++) {
        if (i < vals.length - 1) {
            html += '<span style="color:' + colorsARR[i + 1] + ';">' + vals[i] + '</span>+';
        } else {
            html += '<span style="color:' + colorsARR[i + 1] + ';">' + vals[i] + '</span>=' + totalHTML;
        }
    }
    $(special2 + 'totalsDiv').html(html);

}

function createDropdownsForItem(item) {
    $(".editflavourmixBody #flavourDropdowns").html('');
    var flavours = JSONtoARR(item.flavours);
    console.log(flavours);
    flavournum = 1;
    for (var i = 0; i < flavours.length; i++) {
        var spec = '';
        if (EDIT_FLAVMIX_CONST) {
            spec = 'e';
        }
        var colorsARR = ['black', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#800000', '#808000', '#008000', '#008080', ];

        var selector = '<div class="flavourBlock" id="' + spec + 'flavourBlockID' + flavournum + '"><input type="text" class="form-control" oninput="renderBottle()"  style="width:150px;  display:inline-block; border:2px solid ' + colorsARR[flavournum] + ';" id="' + spec + 'flavourAmount' + flavournum + '" placeholder="20"/><select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="' + spec + 'flavourSelect' + flavournum + '">' + FLAVOURDROPDOWN + '</select></div>';
        $(".editflavourmixBody #flavourDropdowns").prepend(selector);
        $("#" + spec + "flavourAmount" + flavournum).val(flavours[i].val);
        $("#" + spec + "flavourSelect" + flavournum).val(flavours[i].sku)
        flavournum++;
    }
    flavournum = flavours.length;
    renderBottle();
}

function alert_deletion(msg) {
    alert(msg);
}

function JSONtoARR(data) {
    if (data) {
        var result = Object.keys(data).map(function(key) {
            return data[key];
        });

        return result;
    } else {
        return [];
    }

}

$("#priorityButton").on('click', function() {
    $("#priorityDropdowns").html('');
    google.script.run.withSuccessHandler(populateOrderIDsPriority).getOrderIDs('priority');
    $("#updating").css("display", "block");
});

var PRIORITYDROPDOWN = '';
var prioritynum = 0;

function populateOrderIDsPriority(data) {
    prioritynum = 0;
    PRIORITYDROPDOWN = '';
    var html = '<option value="null" />';
    for (var i = 0; i < data.length; i++) {
        html += '<option value="' + data[i][2] + '" orderID="' + data[i][1] + '" >' + data[i][1] + '<option>';
    }
    PRIORITYDROPDOWN = html;
    $("#updating").css("display", "none");
    $("#priorityPlusButton").click();
}

$("#priorityPlusButton").on('click', function() {
    prioritynum++;

    var selector = '<div class="priorityBlock" id="priorityBlockID' + prioritynum + '"><select style="margin: 5px auto; width: 400px; display: inline-block;" class="form-control" id="prioritySelect' + prioritynum + '"   onchange="checkifPriority(this)"  prioritynum="' + prioritynum + '"  >' + PRIORITYDROPDOWN + '</select>';
    selector += '<input type="text" class="form-control"  style="width:150px;display:inline-block; " id="priorityAmount' + prioritynum + '" /></div>';

    $("#priorityDropdowns").append(selector);
});
var NEWFLAVOURSINFLAVOURMIX = [];

function checkifPriority(event) {
    var value = $(event).val();
    var prioritynum = $(event).attr('prioritynum');
    if (value == 'null') {
        $("#priorityAmount" + prioritynum).val('');
    } else {
        $("#priorityAmount" + prioritynum).val(value);
    }
}
$("#priorityMinusButton").on('click', function() {
    $("#priorityDropdowns #priorityBlockID" + prioritynum).remove();
    if (prioritynum != 0) {
        prioritynum--;
    }

});
$('#savepriorityButton').on('click', function(e) {
    var special = '';
    var newPRIORITIES = [];

    for (var i = 1; i <= prioritynum; i++) {
        var priority = $("#priorityAmount" + i).val();
        var oldpriority = $("#prioritySelect" + i).val();
        if (priority == 'null') {
            continue;
        }
        var orderID = $("#prioritySelect" + i + " option:selected").attr('orderID');
        if (orderID) {
            if (priority != oldpriority) {
                newPRIORITIES.push([priority, oldpriority, true, orderID]);
            }
        }
    }
    console.log(newPRIORITIES);
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(successPriorityEdit).setPriorityARR(newPRIORITIES);

});

function successPriorityEdit(e) {
    alert(e);
    filterpage('xx', true);
    // google.script.run.withSuccessHandler(populateOrderIDsPriority).getOrderIDs('priority');
    $("#updating").css("display", "none");
}

// DELETE AND REVERSE

function deleteandreverseSelected() {

    var ms = "WARNING! You are about to delete all the selected orders.All their stock allocations will be reversed. \n Do you wish to proceed?";
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo(SELECTED, 'deleteandreverse');

    }

}

function deleteandreverseSingle(event) {

    var ms = "WARNING! You are about to delete the selected order. All the stock allocations will be reversed. \n Do you wish to proceed?";
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo([$(event).attr('batch')], 'deleteandreverse');

    }
    return false;
}

function reverseSelected() {

    var ms = "WARNING! You are about to reverse all the selected orders.All their stock allocations will be reversed. \n Do you wish to proceed?";
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo(SELECTED, 'reverse');

    }

}

function reverseSingle(event) {

    var ms = "WARNING! You are about to reverse the selected order. All the stock allocations will be reversed. \n Do you wish to proceed?";
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(buildhtmlmodal).getBatchInfo([$(event).attr('batch')], 'reverse');

    }
    return false;
}
var htmlModalType;
var modalclosed = true;
var loopTimeout = 0;

function buildhtmlmodal(rett) {
    $('.htmlMSGmodalbody').html('');
    try {
        loopTimeout = 0;
        var data = rett[0];
        var type = rett[1];
        htmlModalType = type;
        var built = '';
        switch (type) {
            case 'backupAndRestore':
                built = buildbackupAndRestore(data);
                break;
            case 'deleteandreverse':
                built = buildDeleteAndReverse(data);
                break;
            case 'reverse':
                built = buildReverse(data);
                break;
            case 'statuscheck':
                built = buildCheckStock(data);
                break;
            case 'generatePUB':
                built = buildgeneratePUB(data);
                break;
            case 'createAutoPUB':
                built = buildAutoPUB(data);
                break;
            case 'Machines':
                built = buildMachinesModal(data);
                break;
            case 'SchedulePrompt':
                built = buildSchedulePrompt();
                break;
            case 'FillLevels':
                built = buildFillTimeManagement(data);
                break;
            case 'ScheduleManage':
                built = buildScheduleManagement(data);
                break;
            case 'PackagePrint':
                built = buildPackagePrint(data);
                break;
            case 'Roundups':
                built = buildRoundups(data);
                break;
            case 'globalFilter':
                built = buildglobalFilter(data);
                break;
            case 'htmlMSG':
                built = buildHtmlMsg(data);
                break;
            case 'premixSafety':
                built = buildPremixSelector(data);
                break;
            case 'notesModal':
                built = buildNotesModal(data);
                break;
            default:

                break;
        }
        $('.htmlMSGmodalbody').html(built);
        modalclosed = false;
        $('#htmlMSGmodal').modal('show');
        $('.modal-backdrop').show();
        $('#htmlMSGmodal').show();

    } catch (e) {

        alert(rett);
    }
    $("#updating").css("display", "none");
}

var DELandREVData = [];

function buildDeleteAndReverse(list) {
    DELandREVData = list;
    console.log(list);
    var html = '';
    html += '<h2>Status of orders</h2>';
    html += '<table class="table"><thead><tr><th>Batch</th><th>Orders</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Delete Status</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < list.length; i++) {
        html += '<tr>';

        for (var j = 0; j < list[i].length; j++) {
            if (j == 0) {
                html += '<td>' + list[i][j] + '</td>';
            } else {

                if (list[i][j][0] == 'Completed') {
                    html += '<td bgcolor="#1BEF5B">';
                } else if (list[i][j][0] == 'Busy' || list[i][j][0] == 'started') {
                    html += '<td bgcolor="#1BCFEF">';
                } else {
                    html += '<td>';
                }

                html += list[i][j][0] + '</td>';
            }
        }
        html += '<td><input class="deletereversecheckbox" type="checkbox" value="' + list[i][0] + '" checked></td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    html += '<br />';
    html += '<br />';
    html += '<button class="btn btn-success" style="margin:20px;" onclick="deleteandreverseTHESE()">Delete Checked</button></div>';

    return html;
}
var REVData = [];

function buildReverse(list) {
    REVData = list;
    console.log(list);
    var html = '';
    html += '<h2>Status of orders</h2>';
    html += '<table class="table"><thead><tr><th>Batch</th><th>Orders</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Reverse Status</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < list.length; i++) {
        html += '<tr>';

        for (var j = 0; j < list[i].length; j++) {
            if (j == 0) {
                html += '<td>' + list[i][j] + '</td>';
            } else {

                if (list[i][j][0] == 'Completed') {
                    html += '<td bgcolor="#1BEF5B">';
                } else if (list[i][j][0] == 'Busy' || list[i][j][0] == 'started') {
                    html += '<td bgcolor="#1BCFEF">';
                } else {
                    html += '<td>';
                }

                html += list[i][j][0] + '</td>';
            }
        }
        html += '<td><input class="reversecheckbox" type="checkbox" value="' + list[i][0] + '" checked></td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    html += '<br />';
    html += '<br />';
    html += '<button class="btn btn-success" style="margin:20px;" onclick="reverseTHESE()">Reverse Checked</button></div>';

    return html;
}

function buildCheckStock(list) {
    DELandREVData = list;
    console.log(list);
    var html = '';
    html += '<h2>Status of orders</h2>';
    html += '<table class="table"><thead><tr><th>Batch</th><th>Order ID</th><th>Start Time</th><th>Customer</th><th>Orders</th><th>Production</th><th>Printing</th><th>Labelling</th><th>Packaging</th><th>Date Shipped</th><th>Shipping Code</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < list.length; i++) {
        html += '<tr>';
        var skipRows = [0, 1, 2, 3, 4, 5];
        for (var j = 0; j < list[i].length; j++) {
            if (j == 4 || j == 5) {
                continue;
            }
            if (j == 0 || j == 1 || j == 2 || j == 3 || j == 4 || j == 5) {
                html += '<td>' + list[i][j] + '</td>';
            } else {
                if (list[i][j][0] == 'Completed') {
                    html += '<td bgcolor="#1BEF5B">';
                } else if (list[i][j][0] == 'Busy' || list[i][j][0] == 'started') {
                    html += '<td bgcolor="#1BCFEF">';
                } else {
                    html += '<td>';
                }

                html += list[i][j][0] + '</td>';
            }
        }
        html += '<td>' + list[i][4] + '</td>';
        html += '<td>' + list[i][5] + '</td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    html += '<br />';
    html += '<br />';
    html += '</div>';

    return html;
}

function buildgeneratePUB(data) {

    var html = '';
    html += '<h2>Status of orders</h2>';
    html += '<p>' + data + '</p>';

    return html;
}

function deleteandreverseTHESE() {
    var ms = 'Are you sure you want to proceed?'
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        var arr = [];
        $('input.deletereversecheckbox:checkbox:checked').each(function() {
            arr.push($(this).val());
        });
        var final = [];

        for (var j = 0; j < DELandREVData.length; j++) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == DELandREVData[j][0]) {
                    final.push(DELandREVData[j])
                }
            }
        }
        console.log(final);

        google.script.run.withSuccessHandler(deleteandreverseSuccess).deleteAndReverse(final, 'delete');
        $('#htmlMSGmodal').modal('hide');

    }
}

function reverseTHESE() {
    console.log('REVData', REVData);
    var ms = 'Are you sure you want to proceed?'
    var r = confirm(ms);
    if (r == true) {
        $("#updating").css("display", "block");
        var arr = [];
        $('input.reversecheckbox:checkbox:checked').each(function() {
            arr.push($(this).val());
        });
        var final = [];

        for (var j = 0; j < REVData.length; j++) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == REVData[j][0]) {
                    final.push(REVData[j])
                }
            }
        }
        console.log(final);

        google.script.run.withSuccessHandler(deleteandreverseSuccess).deleteAndReverse(final, 'reverse');
        $('#htmlMSGmodal').modal('hide');

    }
}

function deleteandreverseSuccess(msg) {

    filterpage('xx', true);
    alert(msg);
    $("#updating").css("display", "none");
}

$("#generatePUB").on('click', function() {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(buildhtmlmodal).generatePremixBrandUnbrand();

})
var tempPUB;

function createReferenceItems() {
    var id = $('#mysheet13').val();
    $('#htmlMSGmodal').modal('hide');
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(checkProccessStatus).updateGeneratedData(tempPUB, id);

}

function createReferenceSuccess(msg) {
    $("#updating").css("display", "none");
    alert(msg);
}

function buildAutoPUB(data) {
    tempPUB = data;
    var html = '<div>';
    html += '<h2>Generated Items</h2>';

    html += '<table class="table"><thead><tr><th>Row</th><th>Premix</th><th>Colored Premix</th><th>Unbranded</th><th>Branded</th></tr></thead>';
    html += '<tbody>';
    if (data[4]) {
        for (var i = 0; i < data[0].length; i++) {
            html += '<tr>';
            html += '<td>' + (i + 2) + '</td>';
            if (data[0][i][0]) {
                html += '<td>' + data[0][i][0] + ' - ' + data[0][i][1] + '</td>';
            } else {
                html += '<td>-/-</td>';
            }
            if (data[1][i][0]) {
                html += '<td>' + data[1][i][0] + ' - ' + data[1][i][1] + '</td>';
            } else {
                html += '<td>-/-</td>';
            }
            if (data[2][i][0]) {
                html += '<td>' + data[2][i][0] + ' - ' + data[2][i][1] + '</td>';
            } else {
                html += '<td>-/-</td>';
            }
            if (data[3][i][0]) {
                html += '<td>' + data[3][i][0] + '</td>';
            } else {
                html += '<td>-/-</td>';
            }
            html += '</tr>';
        }
    }
    html += '<tr><td></td><td></td><td></td><td></td><td><button class="btn btn-success" onclick="createReferenceItems()" id="createReferenceItems">Save</button></td></tr>';

    html += '</tbody></table>';
    if (data[5][0]) {
        html += '<h4>Failed Items</h4> <p> These Items have failed because the listed flavour and/or recipe wasnt found in the database.</p> <br>';
        html += '<table class="table"><thead><tr><th>Product Code</th><th>Recipe ID</th><th>Flavour ID</th></tr></thead>\
<tbody>';
        for (var i = 0; i < data[5].length; i++) {
            html += '<tr>\
<td>' + data[5][i][0] + '</td>\
<td>' + data[5][i][1] + '</td>\
<td>' + data[5][i][2] + '</td>\
</tr>';
        }

        html += '</tbody></table>';
    }
    html += '</div>';
    return html;
}

function checkProccessStatus(resp) {
    console.log(resp);
    console.log('looped', loopTimeout);
    if (loopTimeout == 360) {
        loopTimeout = 0;
        resp[1] == 'FAILED'
    } else {
        loopTimeout += 20;
    }
    switch (resp[1]) {
        case 'importBlankPCPC2':
            if (resp[0]) {
                loopTimeout = 0;
                buildhtmlmodal(resp[2]);
            } else {

                google.script.run.withSuccessHandler(checkProccessStatus).importBlankPCPC2Ping($('#mysheet13').val());
            }
            break;
        case 'updateGeneratedData':
            if (resp[0]) {
                loopTimeout = 0;
                createReferenceSuccess(resp[2]);
            } else {

                google.script.run.withSuccessHandler(checkProccessStatus).updateGeneratedDataPing();
            }
            break;
        case 'restorePoint':
            if (resp[0]) {
                loopTimeout = 0;
                createRestoreSuccess(resp[2]);
            } else {

                google.script.run.withSuccessHandler(checkProccessStatus).restorePointPing();
            }
            break;
        default:
            alert('FAILED');
            $("#updating").css("display", "none");
            return;
    }

}

//SCHEDULING CODE

$("#saveSchedule").on('click', function() {

    buildhtmlmodal(['', 'SchedulePrompt']);

});

function buildSchedulePrompt() {
    var html = '';
    html += '<div class="schedulePrompt">';
    html += '<p>Please enter a name and select how the schedule will be saved.</p>';
    html += '<div>';
    html += '<div class="form-group">';
    html += '<label for="scheduleName">Name</label>';
    html += '<input type="text" class="form-control" id="scheduleName"  placeholder="Name">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label for="exampleInputPassword1">Save Type:</label>';
    html += '<select class="form-control" id="scheduleSaveType"  onchange="checkSaveTypeScheduler(this)"><option value="automatic">Automatic</option  selected><option value="manual">Manual</option></select>';
    html += '</div>';
    html += '<div class="form-group" style="display:none" id="manualTime">';
    html += '<select   class="form-control" id="scheduleInsert" title="Auto allocate schedule from the selected date, or Insert the schedule and move any others down." style="display:inline-block;" ><option value="auto">Auto</option><option value="insert">Insert</option></select>';
    html += '<input type="date" class="form-control" style="display:inline-block;" id="scheduleDate" onchange="checkSaveDateScheduler(this)"/><select   class="form-control" id="scheduleTime" style="display:inline-block;" ></select><p id="invaliddate" style="color:red;display:none;">Invalid date.</p>'
    html += '</div>';
    html += '<button type="button" class="btn btn-success" id="saveScheduleButton" onclick="saveSchedulefunction()">Save</button>';
    html += '</div>';
    html += '<div style="margin-top:50px;">\
  <div"><table class="table"><thead><tr><th>Select Date to Preview:</th><th><input type="date" class="form-control" style="display:inline-block;" onchange="loadSchedulePreview(this)"/></th></tr></thead></table></div>\
   <div id="schedulePreview"></div>\
  </div>';
    html += '</div>';

    return html;
}

function loadSchedulePreview(event) {
    var date = new Date($(event).val());
    console.log('date.getTime()', date.getTime());
    google.script.run.withSuccessHandler(renderSchedule).GetSchedulePreview(date.getTime());

}

function renderSchedule(schedule) {
    console.log('schedule', schedule);
    if (schedule.length == 0) {
        $('#schedulePreview').html('');
        return;
    }
    var html = '<table class="table"><thead><tr>';
    for (var i = 0; i < schedule[0].length; i++) {
        html += '<th>' + schedule[0][i] + '</th>';
    }
    html += '</tr></thead>\
<tbody>';

    for (var i = 1; i < schedule.length; i++) {
        var found = false;
        for (var j = 1; j < schedule[i].length; j++) {
            if (schedule[i][j] && schedule[i][j] != " ") {
                found = true;
                break;
            }
        }
        if (!found) {
            continue;
        }
        html += '<tr>';
        for (var j = 0; j < schedule[i].length; j++) {
            if (schedule[i][j]) {
                html += '<td style="border-top: 1px solid #e9ecef;" >' + schedule[i][j] + '</td>';
            } else {
                html += '<td style="border-top: 1px solid #e9ecef;" bgcolor="#afafaf"></td>';
            }
        }
        html += '</tr>';
    }
    html += '</tbody></table>';

    $('#schedulePreview').html(html);
}

function checkSaveTypeScheduler(event) {
    var html = '';
    if ($(event).val() == 'manual') {
        $('#manualTime').show();
    } else {
        $('#manualTime').hide();
    }
}

function checkSaveDateScheduler(event) {
    var date = new Date($(event).val());
    var now = new Date();
    if (date.getTime() <= now.getTime() - 1000 * 60 * 60 * 24) {
        $("#invaliddate").show();
    } else {
        $('#invaliddate').hide();
        google.script.run.withSuccessHandler(getTimesOptions).getEmptySchedule(date.getTime());

        function getTimesOptions(data) {
            var html = '';
            var now = new Date();
            now.setUTCHours(0, 0, 0, 0);
            for (var i = 0; i < 288; i++) {
                if (data.indexOf(i * 5) >= 0) {
                    html += "<option value=" + i * 5 + " >" + formatAMPM4(now) + "</option>";
                }
                now = new Date(now.getTime() + 5 * 60 * 1000);
            }
            $("#scheduleTime").html(html);
        }
    }
}

function formatAMPM(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0' + minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

function formatAMPM4(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    //    var ampm = hours >= 12 ? 'pm' : 'am';
    //    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0' + minutes : minutes;
    var strTime = hours + ':' + minutes;
    return strTime;
}

function saveSchedulefunction() {
    var name = $("#scheduleName").val();
    if (!name) {
        alert('Please enter a name!');
        return 0;
    }
    if ($("#scheduleSaveType").val() == 'manual' && !(new Date($("#scheduleDate").val()).getTime())) {
        alert('Please enter a date!');
        return 0;
    }
    var obj = {
        name: name,
        type: $("#scheduleSaveType").val(),
        entryDate: (new Date()).getTime(),
    }
    if (obj.type == 'manual') {
        obj.date = new Date($("#scheduleDate").val());
        obj.date = new Date(obj.date).setUTCHours(0, 0, 0, 0);

        obj.time = $("#scheduleTime").val();
    }
    $("#updating").css("display", "block");

    var saveType = $("#scheduleInsert").val();
    if (saveType == 'auto') {
        google.script.run.withSuccessHandler(schedulesaveSuccess).saveSchedule(splitPAGES, obj);
    } else {
        google.script.run.withSuccessHandler(schedulesaveSuccess).insertNewSchedule(splitPAGES, obj);
    }
}

function schedulesaveSuccess(msg) {

    alert(msg);
    $("#updating").css("display", "none");
}

function refreshMachines(msg) {
    $("#machineopssku").val('');
    $("#machineopsname").val('');
    $("#machineopsfillLevels").val('');
    $("#machineopsactive").prop('checked', false);
    $("#MachineOps").hide();

    alert(msg);
    google.script.run.withSuccessHandler(buildhtmlmodal).getMachines();
}

$("#machineManage").on('click', function() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getMachines();

});

function buildMachinesModal(data) {
    var html = '';
    var dropdown = '<option></option>';
    for (var i = 0; i < data.length; i++) {
        dropdown += '<option sku="' + data[i].sku + '" value="' + data[i].sku + '">' + data[i].name + '</option>';
    }
    html += '<div>';
    html += '<p>Please make sure the Machine fill levels follow the format: 10,20,32,35, etc... If a machine is active, but has no fill levels, then it will not be used in scheduling.</p>';
    html += '<table class="table"><head>';
    html += '<tr><th>Machines</th><th>Status</th><th>Fill Levels</th><th></th><th></th></tr></head>';
    html += '<body>';
    for (var i = 0; i < data.length; i++) {
        var selectedDropdown = dropdown;
        if (data[i].follow) {
            selectedDropdown = selectedDropdown.replace('sku="' + data[i].follow + '"', 'sku="' + data[i].follow + '" selected');

        }
        html += '<tr><td>' + data[i].name + '</td>';
        var status = data[i].status ? "ON" : "OFF";
        html += '<td>' + status + '</td>';
        html += '<td>' + data[i].fillLevels + '</td>';
        html += '<td><button   type="button" class="btn btn-primary" fillLevels="' + data[i].fillLevels + '" status="' + data[i].status + '"  sku="' + data[i].sku + '" name="' + data[i].name + '" onclick="editMachine(this)">Edit</button></td><td><button  type="button" class="btn btn-danger" sku="' + data[i].sku + '"   status="' + data[i].status + '"  name="' + data[i].name + '"  onclick="deleteMachine(this)">Delete</button></td></tr>'

    }
    html += '<tr><td></td><td></td><td></td><td></td><td><button class="btn btn-success" onclick="newMachine()">New Machine</button></td></tr>';
    html += '</body></table>';

    html += '<div id="MachineOps" style="display:none">';
    html += '<table class="table"><thead><tr><th>SKU</th><th>Status</th><th>Fill Levels</th><th>Name</th><th></th></tr></thead><tbody>';
    html += '<tr><td><input type="text" id="machineopssku" class="form-control" disabled></td>';
    html += '<td><input class="form-control" type="checkbox"  id="machineopsactive" /></td>';
    html += '<td><input class="form-control" type="text"  id="machineopsfillLevels" /></td>';
    html += '<td><input type="text" id="machineopsname" class="form-control" /></td></tr>';
    html += '<tr><td><button type="button" class="btn btn-success"  onclick="saveMachine()">Save Machine</button></td><td></td></tr>';
    html += '</tbody></table></div>';
    html += '</div>';
    return html;

}

function changeMachineLogic(event) {
    var machine1 = $(event).attr('sku');
    var machine2 = $(event).val();
    google.script.run.withSuccessHandler(schedulesaveSuccess).changeMachineLogic(machine1, machine2);
}

function newMachine(event) {

    $("#machineopssku").prop('disabled', false);
    $("#MachineOps").show();
}

function editMachine(event) {
    $("#machineopssku").prop('disabled', true);
    $("#machineopssku").val($(event).attr('sku'));
    $("#machineopsactive").prop('checked', $(event).attr('status'));
    $("#machineopsname").val($(event).attr('name'));
    $("#machineopsfillLevels").val($(event).attr('fillLevels'));
    $("#MachineOps").show();

}

function deleteMachine(event) {

    var sku = $(event).attr('sku');
    if (confirm("Are you sure you want to delete this Machine?")) {
        google.script.run.withSuccessHandler(refreshMachines).remove_item(sku, 'Machines');
    }
}

function saveMachine() {
    var obj = {
        sku: $("#machineopssku").val(),
        name: $("#machineopsname").val(),
        status: $("#machineopsactive").prop('checked'),
        fillLevels: $("#machineopsfillLevels").val(),
    }
    if (!obj.sku) {
        alert('No SKU!');
        return false;
    }
    google.script.run.withSuccessHandler(refreshMachines).newBasicItem(obj, 'Machines');
}

$("#FillTimeManage").on('click', function() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getFillLevels();

});

function refreshFillTimes(msg) {

    alert(msg);
    google.script.run.withSuccessHandler(buildhtmlmodal).getFillLevels();
}

function buildFillTimeManagement(data) {

    var html = '';

    html += '<div>';
    html += '<p>Please write in the ammount of time in <b>minutes.</b> Ex. 30ml: 1.5 </p>';
    html += '<table class="table"><head>';
    html += '<tr><th>Fill</th><th>Time</th><th></th></tr></head>';
    html += '<body>';
    for (var i = 0; i < data.length; i++) {

        html += '<tr><td>' + data[i].name + 'ml</td><td><input class="form-control" id="fillTime' + data[i].sku + '" sku="' + data[i].sku + '" oninput="showSaveChange(this)" value="' + data[i].time + '"></td><td><button  type="button" class="btn btn-success" id="saveChange' + data[i].sku + '" sku="' + data[i].sku + '"  name="' + data[i].name + '"  style="display:none;" onclick="saveChange(this)">Save</button></td><td><button  type="button" class="btn btn-danger" sku="' + data[i].sku + '"  name="' + data[i].name + '"  onclick="deleteFill(this)">Delete</button></td></tr>'

    }
    html += '<tr><td></td><td></td><td></td><td><button class="btn btn-success" onclick="newFill()">New Fill</button></td></tr>';
    html += '</body></table>';

    html += '<div id="FillOps" style="display:none">';
    html += '<table class="table"><thead><tr><th>Fill</th></tr></thead><tbody>';
    html += '<tr><td><input type="text" id="fillamount" class="form-control" ></td></tr>';
    html += '<tr><td><button type="button" class="btn btn-success"  onclick="saveFill()">Save Fill</button></td></tr>';
    html += '</tbody></table></div>';
    html += '</div>';
    return html;
}

function newFill(event) {

    $("#machineopssku").prop('disabled', false);
    $("#FillOps").show();
}

function showSaveChange(event) {
    $("#saveChange" + $(event).attr('sku')).show();
}

function deleteFill(event) {

    var sku = $(event).attr('sku');
    if (confirm("Are you sure you want to delete this Fill?")) {
        google.script.run.withSuccessHandler(refreshFillTimes).remove_item(sku, 'FillLevels');
    }
}

function saveChange(event) {

    var sku = $(event).attr('sku');
    var time = $("#fillTime" + $(event).attr('sku')).val();
    var obj = {
        sku: sku,
        time: parseFloat(time),

    }
    google.script.run.withSuccessHandler(schedulesaveSuccess).changeFillLevelTime(obj);

}

function saveFill() {
    var obj = {
        sku: $("#fillamount").val(),
        name: $("#fillamount").val(),
        time: 1,
    }
    if (!obj.sku) {
        alert('No SKU!');
        return false;
    }
    $('#htmlMSGmodal').modal('hide');
    google.script.run.withSuccessHandler(refreshFillTimes).newBasicItem(obj, 'FillLevels');
}

function setScheduleDropdown(data) {
    var html = '';
    if (data) {
        for (var i = 0; i < data.length; i++) {
            html += '<option value="' + data[i][0] + '">' + data[i][1] + '</option>';

        }
    }
    $('#scheduleSelect').html(html);
    $("#updating").css("display", "block");
    console.log('selPage setScheduleDropdown', selPage);
    google.script.run.withSuccessHandler(filterResult).getScheduleDataNearest(selPage);

}
$('#getSelectedScheduleButton').on('click', function() {
    var selectedID = $('#scheduleSelect').val();

    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(filterResult).getScheduleData(selectedID, selPage);
});

$('#scheduleManage').on('click', function() {
    refreshScheduleView();

});

function refreshScheduleView() {

    google.script.run.withSuccessHandler(buildhtmlmodal).getScheduleView();

}

var ScheduleData = [];

function buildScheduleManagement(rett) {
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    console.log(rett);
    var data = rett[0];
    ScheduleData = rett[0];
    var Breaks = rett[1];
    var scheduleSelector = '';
    var html = '<div >';
    html += getNavBarSchedule();
    html += '<div id="BreaksView" class="scheduleDivs" style="display:none;"><br><br><h2>Breaks</h2>\
        <p>Please write in shifts and breaks in the format: HH:MM - HH:MM, HH:MM - HH:MM   <br> Example: 12:30 - 13:00, 17:00 - 17:30 </p>\
      <table class="table">\
 <thead><tr><th>Day</th><th>Active</th><th>Shifts</th><th>Breaks</th></tr></thead>\
 <tbody>';
    for (var i = 0; i < days.length; i++) {
        html += '<tr>';
        html += '<td>' + days[i] + '</td>';
        html += '<td><input class="form-control" type="checkbox"  id="active' + days[i] + '"';
        if (Breaks[days[i]]) {
            html += 'checked >'
        } else {
            html += ' >'
        }
        html += '</td>';

        if (Breaks[days[i]]) {
            html += '<td><input class="form-control" type="text"  id="shifts' + days[i] + '" value="' + Breaks[days[i]].shiftTimes + '"></td>';
        } else {
            html += '<td><input class="form-control" type="text"  id="shifts' + days[i] + '"></td>';
        }

        if (Breaks[days[i]]) {
            html += '<td><input class="form-control" type="text"  id="breaks' + days[i] + '" value="' + Breaks[days[i]].breakTimes + '"></td>';
        } else {
            html += '<td><input class="form-control" type="text"  id="breaks' + days[i] + '"></td>';
        }
        html += '</tr>';
    }

    html += '</tbody></table>\
<button type="button" class="btn btn-default" id="saveBreaks" onclick="saveBreaks(this)">Save Breaks</button>\
</div>';
    html += '<div  id="schedulesView" class="scheduleDivs"><br><br><h2>Schedules</h2><table class="table">';
    html += '<thead><tr><th>Entry Date</th><th>Scheduled For</th><th>Name</th><th>Type</th><th>View</th></tr></thead>';
    html += '<tbody>';
    for (var i = 0; i < data.length; i++) {
        html += '<tr>';
        for (var j = 1; j < data[i].length - 1; j++) {
            if (j == 1) {
                html += '<td>' + formatDateDisplay2(data[i][j]) + '</td>';
            } else if (j == 2) {
                html += '<td>' + formatDateDisplay(data[i][j]) + '</td>';
            } else {

                html += '<td>' + data[i][j] + '</td>';
            }
        }
        html += '<td><button type="button" class="btn btn-default" id="' + i + '" onclick="PreviewSchedule(this)">View</button></td>';
        html += '</tr>';
        scheduleSelector += '<option value="' + data[i][1] + '">' + data[i][3] + '</option>';
    }

    html += '</tbody></table>\
        <p><br></p></div>\
        <div id="EditScheduleView" class="scheduleDivs" style="display:none;"></div>\
        <div id="PrintScheduleView" class="scheduleDivs" style="display:none;">\
          <select class="form-control" id="SchedulePrintType" onchange="SchedulePrintTypeChange()" ><option value="Today">Today</option><option value="FromTo">From - To</option><option value="scheduleSelect">Schedule</option></select>\
          <div id="PrintToday" class="printInnerDiv"><p>Only Todays Schedule Will Be Printed</p></div>\
          <div id="PrintFromTo" style="display:none;" class="printInnerDiv">\
          <p>Select Dates "From" and "To" to print schedules.</p>\
          <br>\
           <input type="date" class="form-control" id="fromSchedulePrint"\>\
           <input type="date" class="form-control" id="toSchedulePrint"\>\
            <br>\
          </div>\
          <div id="PrintscheduleSelect" style="display:none;" class="printInnerDiv">\
            <p>Select one or multiple Schedules to print.</p>\
            <br>\
            <select class="form-control" id="scheduleSelector" multiple>' + scheduleSelector + '</select>\
             <br>\
          </div>\
          <button type="button" class ="btn btn-success" onclick="printSchedule()">Print</button>\
          </br>\
          <span id="schedulePrintResult"></span>\
        </div>\
        </div>';
    return html;
}

function SchedulePrintTypeChange() {
    var printType = $("#SchedulePrintType").val();
    $(".printInnerDiv").hide();
    $("#Print" + printType).show();

}

function printSchedule() {
    var type = $("#SchedulePrintType").val();
    var opt = {};
    if (type == 'Today') {} else if (type == 'FromTo') {
        opt.from = new Date($("#fromSchedulePrint").val()).setUTCHours(0, 0, 0, 0);
        opt.to = new Date($("#toSchedulePrint").val()).setUTCHours(0, 0, 0, 0);
    } else {
        var items = [];
        $('#scheduleSelector option:selected').each(function() {
            items.push($(this).val());
        });
        opt.selected = items;
    }
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(schedulePrintSuccess).printSchedules(opt, type);

}

function schedulePrintSuccess(item) {
    $("#updating").css("display", "none");
    var html = "";
    if (!item.error) {
        html += "<p>Recently Printed Schedule:</p>";
        html += '<br>'
        html += '<a  target="_blank" href="' + item.url + '">' + item.name + '</a>'
    } else {
        html += '<h5>' + item.error + '</h5>'
    }
    $("#schedulePrintResult").html(html);

}

var ScheduleBeingEdited = [];

function PreviewSchedule(event) {
    var id = $(event).attr('id');
    ScheduleBeingEdited = ScheduleData[id][0];
    var existingTimes = '';
    var now = new Date();
    now.setUTCHours(0, 0, 0, 0);
    for (var i = 0; i < 288; i++) {

        existingTimes += "<option value=" + i * 5 + " >" + formatAMPM4(now) + "</option>";

        now = new Date(now.getTime() + 5 * 60 * 1000);
    }
    var html = '<p>All Edited Schedules will have their TYPE changed to "manual" if anything other than their Name is changed..</p>';
    html += '<table class="table"><thead>\
<tr><th>Entry Date:</th><th>' + formatDateDisplay2(ScheduleData[id][0].entryDate) + '</th></tr>\
<tr><th>Type:</th><th><input  class="form-control" id="scheduleType" value="' + ScheduleData[id][0].type + '" disabled /></th></tr>\
<tr><th>Name:</th><th><input  class="form-control" id="scheduleName" value="' + ScheduleData[id][0].name + '"/></th></tr>\
<tr><th>Date Scheduled For:</th><th><input  class="form-control" type="date" id="scheduledDate" value="' + formatDateInput(ScheduleData[id][2]) + '"/></th></tr>';

    var selectedDropdown = existingTimes;

    if (ScheduleData[id][0].time) {
        selectedDropdown = selectedDropdown.replace('value="' + ScheduleData[id][0].time + '"', 'value="' + ScheduleData[id][0].time + '" selected');
        html += '<tr><th>Time Scheduled For:</th><th><select  class="form-control" type="date" id="scheduledTime">' + selectedDropdown + '</select></th></tr>';
    } else {
        html += '<tr><th>Time Scheduled For:</th><th><select  class="form-control" type="date" id="scheduledTime">' + selectedDropdown + '</select></th></tr>';
    }
    html += '</thead></table>';
    html += '<p>' + ScheduleData[id][ScheduleData[id].length - 1] + '</p>';

    html += '<button type="button" class="btn btn-success"  onclick="SaveScheduleEdit(this)">Save</button><button type="button" class="btn btn-danger" style="margin-left:25px;"  onclick="deleteSchedule(this)">Delete</button>';
    $("#EditScheduleView").html(html);
    $("#EditScheduleView").html(html);
    $("#EditScheduleViewButton").click();
}

function SaveScheduleEdit() {
    var today = new Date().getTime();
    var obj = {
        type: 'manual',

        date: $("#scheduledDate").val(),
        time: $("#scheduledTime").val(),
        name: $("#scheduleName").val(),
    }
    var selectedDate = new Date(obj.date).getTime();
    if (selectedDate < today) {
        alert('Invalid Date. Item Can not be scheduled in the Past.');
        return;
    }
    obj.date = new Date(obj.date);
    obj.date = obj.date.setUTCHours(0, 0, 0, 0);
    google.script.run.withSuccessHandler(refreshScheduleView).editSchedule(obj, ScheduleBeingEdited);

}

function deleteSchedule() {
    var text = 'Are you sure you want to delete this schedule?';
    if (confirm(text)) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(refreshScheduleView).DeleteSchedule(ScheduleBeingEdited);
    }
}

function saveBreaks() {
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    var options = '{';
    for (var i = 0; i < days.length; i++) {
        var status = $("#active" + days[i]).is(":checked");

        var obj = {
            shiftTimes: $("#shifts" + days[i]).val(),
            breakTimes: $("#breaks" + days[i]).val(),
            status: status,
        }
        if (status) {
            options += '"' + days[i] + '":' + JSON.stringify(obj) + ',';
        }

    }
    options += '}';

    google.script.run.withSuccessHandler(refreshScheduleView).saveBreaks(options);
}

function getNavBarSchedule() {
    var html = '';

    html += '<nav class="navbar navbar-expand-lg navbar-light">\
  <div class="collapse navbar-collapse" id="navbarSupportedContent">\
    <ul class="navbar-nav mr-auto">\
      <li class="nav-item active">\
        <button type="button" class="btn btn-primary navButton" name="schedulesView"  onclick="navBarEvent(this)">Schedules</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="PrintScheduleView"  onclick="navBarEvent(this)" >Print Schedule</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="BreaksView"  onclick="navBarEvent(this)" >Shifts/Breaks</button>\
      </li>\
      <li class="nav-item">\
         <button type="button" class="btn btn-primary navButton" name="EditScheduleView" id="EditScheduleViewButton" onclick="navBarEvent(this)" >Edit Schedule</button>\
      </li>\
  </div>\
</nav>';

    return html;
}

function navBarEvent(event) {
    var name = $(event).attr('name');
    $('.scheduleDivs').hide();
    $('#' + name).show();

}

function closemainmodal() {
    console.log('here');
    modalclosed = true;
    $('#htmlMSGmodal').hide();
    $('.modal-backdrop').hide();
}

function buildPackagePrint(msg) {
    var html = '<div>\
<h3>Packaging:</h3>\
<p>' + msg + '</p>\
<br/>';

    html += '<button type="button" class="btn btn-primary" onclick="printSelectedAdmin()" >Continue</button>';

    html += '</div>';
    return html;
}

function printSelectedAdmin() {
    closemainmodal();
    google.script.run.withSuccessHandler(buildhtmlmodal).printPackagingBatches(SELECTED, true);

}
//END SHCEDULING CODE

function backupAndRestore() {
    var password = prompt("Please enter your password:", "");
    google.script.run.withSuccessHandler(verifyUserResult).verifyUser(password, 'backupAndRestore');
}

function verifyUserResult(result) {
    if (result[0]) {
        switch (result[1]) {
            case 'backupAndRestore':
                google.script.run.withSuccessHandler(buildhtmlmodal).getFileList();
                break;
            default:
                alert('Success');
        }

    } else {
        alert('Wrong Password');
    }
}

function buildbackupAndRestore(arr) {
    var html = '';
    html += '\
<div id="restoreBody"><h2>Backup and Restore</h2><div><p id="restoreStatus"></p></div><ul id="restoreList" class="list-group">';
    for (var i = 0; i < arr.length; i++) {

        html += '<li class="list-group-item" value = "' + arr[i] + '">\
<div class="radio">\
  <label><input style="margin: 0 20px;" type="radio" value="' + arr[i] + '" name="restoreradio">' + formatDateDisplay2(parseInt(arr[i].replace('.gz', ''), 10)) + '</label>\
</div>\
</li>';

    }
    html += '</ul>\
<button type="button" class="btn btn-primary sarButton" onclick="restoreSelected()" >Restore</button>\
<button type="button" class="btn btn-danger sarButton" onclick="deleteSelected()" >Delete</button>\
<button type="button" class="btn btn-success sarButton" onclick="saveCurrentPoint()" >Save Current</button>\
</div>';
    return html;
}

function restoreSelected() {
    var name = $('input[name=restoreradio]:checked').val();
    console.log('restorename', name);

    if (confirm('Restoring to the selected will reset all changes from that point forwards.')) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(checkProccessStatus).restorePoint(name);

    }
}

function deleteSelected() {
    var name = $('input[name=restoreradio]:checked').val();
    console.log('restorename', name);
    if (confirm('Are you sure you want to delete this save?')) {
        $("#updating").css("display", "block");
        google.script.run.withSuccessHandler(saveandrestoremsg).deleteBackup(name);

    }

}

function saveCurrentPoint() {
    $("#updating").css("display", "block");
    alert('Saving');
    google.script.run.withSuccessHandler(saveandrestoremsg).createBackup();
}

function createRestoreSuccess(msg) {
    $('#restoreStatus').html(msg);
    $("#updating").css("display", "none");
}

function saveandrestoremsg(msg) {

    alert(msg);

    google.script.run.withSuccessHandler(buildFileList).getFileList();
}

function buildFileList(rett) {
    var arr = rett[0];
    var html = '';
    for (var i = 0; i < arr.length; i++) {

        html += '<li class="list-group-item" value = "' + arr[i] + '">\
<div class="radio">\
  <label><input style="margin: 0 20px;" type="radio" value="' + arr[i] + '" name="restoreradio">' + formatDateDisplay2(parseInt(arr[i].replace('.gz', ''), 10)) + '</label>\
</div>\
</li>';

    }
    $("#updating").css("display", "none");
    $('#restoreList').html(html);

}

function refreshOrders() {
    $("#updating").css("display", "block");
    google.script.run.withSuccessHandler(refreshOrdersMSG).refreshOrderPC();
}

function refreshOrdersMSG(msg) {
    alert(msg);
    $("#updating").css("display", "none");
}

function getRoundups() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getRoundups();

};

function buildRoundups(data) {
    var html = '';
    html += '\
<div style="margin:0 auto; width:500px;"><h2>Batch and Bottle Size</h2>';
    html += '<div  ><p> Batch Size (L): <input  class="form-control" id="batchsize" value="' + data.batch + '"/>';
    html += '<p> Bottles: <input  class="form-control" id="bottlescount" value="' + data.bottles + '"/><div>';
    html += '<hr></div>\
<div>\
<button type="button" class="btn btn-success sarButton" onclick="saveRoundups()">Save Current</button>';
    return html;
}

function saveRoundups() {
    var obj = {
        batch: parseInt($("#batchsize").val(), 10),
        bottles: parseInt($("#bottlescount").val(), 10),

    }
    google.script.run.withSuccessHandler(refreshOrdersMSG).updateRoundups(obj);

}

function getglobalFilter() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getglobalFilter();

};

function buildglobalFilter(data) {
    var selectedDropdown = '';
    for (var i = 0; i < 7; i++) {

        selectedDropdown += '<option value="' + i + '"' + (data.months == i ? 'selected' : '') + '>';
        if (i == 0) {
            selectedDropdown += 'All';
        } else if (i == 1) {
            selectedDropdown += '1 Month';
        } else {
            selectedDropdown += i + ' Months';
        }

        selectedDropdown += '</option>';

    }

    var html = '';
    html += '\
<div style="margin:0 auto; width:500px;"><h2>Global Date Filter</h2>';
    html += '<div  ><p><select  class="form-control" type="date" id="globalFilterMonths">' + selectedDropdown + '</select></p>';
    html += '<hr></div>\
<div>\
<button type="button" class="btn btn-success sarButton" onclick="saveglobalFilter()">Save Current</button>';
    return html;
}

function saveglobalFilter() {
    var obj = {
        months: parseInt($("#globalFilterMonths").val(), 10),

    }
    console.log('obj', obj);
    google.script.run.withSuccessHandler(refreshOrdersMSG).updateglobalFilter(obj);

}

//REPORTING

function setupReporting(list) {

    //console.log(list);
    var html = '';
    for (var i = 0; i < list.length; i++) {
        html += '<option value="' + list[i] + '">' + list[i] + '</option>';
    }
    //console.log(html);
    $('#OrderIds1').html(html);
    $('#OrderIds2').html('');

}

function generateReport(event) {
    var reportType = $(event).attr('reportType');
    var name = $(event).attr('name');
    var arr = [];
    var myOpts = document.getElementById('OrderIds2').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }
    if (arr.length == 0) {
        arr = ['all'];
    }

    var date1 = $("#startSearchReporting").val();
    var date2 = $("#startSearchReporting").val();
    if (!date1 && !date2) {
        date1 = 'all';
    } else if (!date1 && date2) {
        date1 = 0;
    } else if (date1 && !date2) {
        date2 = new Date().getTime();
    }

    if (date1 && date1 != 'all') {
        date1 = new Date(date1).getTime();
    }

    if (date2) {
        date2 = new Date(date2).getTime();
    } else {
        date2 = new Date().getTime();
    }
    var data = {
        orderIDs: arr,
        shippingdates: [date1, date2]
    }
    $("#updating").css("display", "block");
    console.log(data);
    google.script.run.withSuccessHandler(showReport).createOrdersReport(data, name, reportType)
}

function showReport(obj) {
    $("#updating").css("display", "none");
    $("#reportLink").html('<a href="' + obj.url + '" target="_blank">' + obj.name + '</a>')
}

$('.leftSwitch').click(function() {
    console.log('clicked left1');
    var type1 = $(this).attr('type1');
    var type2 = $(this).attr('type2');

    moveItems(type2, type1);

});

$('.rightSwitch').on('click', function() {
    console.log('clicked right1');
    var type1 = $(this).attr('type1');
    var type2 = $(this).attr('type2');

    moveItems(type1, type2);

});

$('.leftallSwitch').on('click', function() {
    var type1 = $(this).attr('type1');
    var type2 = $(this).attr('type2');

    moveAllItems(type2, type1);

});

$('.rightallSwitch').on('click', function() {
    var type1 = $(this).attr('type1');
    var type2 = $(this).attr('type2');

    moveAllItems(type1, type2);

});

function left(event) {

    var type1 = $(event).attr('type1');
    var type2 = $(event).attr('type2');

    moveItems(type2, type1);

}

function right(event) {

    var type1 = $(event).attr('type1');
    var type2 = $(event).attr('type2');

    moveItems(type1, type2);

}

function leftAll(event) {
    var type1 = $(event).attr('type1');
    var type2 = $(event).attr('type2');

    moveAllItems(type2, type1);

}

function rightAll(event) {
    var type1 = $(event).attr('type1');
    var type2 = $(event).attr('type2');

    moveAllItems(type1, type2);

}
//SAFETY REPORTS

function getpremixReports() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getPremixDropdown();

};

function setupSafetyRepors(list) {

    //console.log(list);
    var html = '';
    for (var i = 0; i < list.length; i++) {
        html += '<option value="' + list[i].sku + '">' + list[i].sku + ' - ' + list[i].name + '</option>';
    }
    return html;
}

function buildPremixSelector(list) {
    var html = '';
    html += '<div class="container">\
<div>\
<p>Select Premix Codes</p>\
<div class="form-group">\
<select id="dd1" class="form-control" multiple="multiple">\
' + setupSafetyRepors(list) + '\
</select>\
</div>\
<br />\
<button type="button" class="leftSwitch" onclick="left(this)" id="leftSwitch" type1="#dd1" type2="#dd2"><i class="fa fa-caret-up" aria-hidden="true"></i></button>\
<button type="button" class="rightSwitch" id="rightSwitch" onclick="right(this)" type1="#dd1" type2="#dd2"><i class="fa fa-caret-down" aria-hidden="true"></i></button>\
<button type="button" class="leftallSwitch" id="leftallSwitch" onclick="leftAll(this)" type1="#dd1" type2="#dd2"><i class="fa fa-caret-square-o-up" aria-hidden="true"></i></button>\
<button type="button" class="rightallSwitch" id="rightallSwitch" onclick="rightAll(this)" type1="#dd1" type2="#dd2"><i class="fa fa-caret-square-o-down" aria-hidden="true"></i></button>\
<br />\
<label for="dd2">Selected</label>\
<div class="form-group">\
<select id="dd2" class="form-control" multiple="multiple">\
</select>\
</div>\
</div>\
<button type="button" class="btn btn-success sarButton" onclick="generateSafetyReports()">Generate</button>';
    return html;
}

function generateSafetyReports() {

    var arr = [];
    var myOpts = document.getElementById('dd2').options;
    for (var i = 0; i < myOpts.length; i++) {
        arr.push(myOpts[i].value);
    }

    $("#updating").css("display", "block");

    google.script.run.withSuccessHandler(htmlModalMSG).printSafetyReports(arr);
}

function generateSafetyReportsSingle(sku) {

    $("#updating").css("display", "block");

    google.script.run.withSuccessHandler(htmlModalMSG).printSafetyReports([sku]);
}

function htmlModalMSG(msg) {
    buildhtmlmodal([msg, 'htmlMSG'])

}

function buildHtmlMsg(msg) {
    var html = '<div  class="container">' + msg + '</div>';

    return html;
}

//NOTES

var notesGlobal = [];
var notesGlobalObj = [];
var selectedNote = false;

function showNotes() {
    google.script.run.withSuccessHandler(buildhtmlmodal).getNotesList();

}

function getNotesGlobal() {

    google.script.run.withSuccessHandler(setNotesGlobal).getNotesObj();
}

function setNotesGlobal(data) {
    notesGlobalObj = data;
    console.log(notesGlobalObj)
}

function buildOrderIDsList(list) {

    //console.log(list);
    var html = '';
    for (var i = 0; i < list.length; i++) {
        html += '<div value="' + list[i][0] + '" onClick="selectNotesForOrder(this)" >' + list[i][0] + ' - Last Change: ' + formatDateDisplay2(list[i][1]) + '</div>';
    }
    return html;
}

function buildNotesModal(list) {
    notesGlobal = list;
    var html = '';
    html += '<div class="container">\
<div>\
<p>Select an Order ID</p>\
<div>\
<select class="form-control" id="notesOrderIDSelect" onchange="setListSorted(this)" ><option value="All" selected>All</option><option value="dont">Don\'t Have Notes</option><option value="have">Have Notes</option></select>\
</div>\
<div class="form-group">\
<div  style="height:200px; overflow:auto;" id="orderIDList" >\
' + buildOrderIDsList(list) + '\
</div>\
</div>\
<br />\
<br />\
<div class="form-group"  id="noteTextHolder"  style="height:340px; display:none;">\
<p>Selected: <span id="selectedOrderID"></span><button type="button" class="btn btn-success sarButton" onclick="saveNote()">Save</button></p>\
<div  >\
<div class="add-note-inner__notes">\
<div class="note-line-textarea">\
<textarea id="noteTextBox" rows="3"  ></textarea>\
</div>\
<div class="notes-container" id="notesContainer"></div>\
</div>\
</div>\
</div>\
</div>';

    return html;
}

function setListSorted(event) {
    var exists = $(event).val();
    console.log(exists);
    var arr = [];
    if (exists == 'All') {
        arr = notesGlobal;
    }

    if (exists == 'have') {

        arr = notesGlobal.filter(function(item) {

            return item[1] != ''
        });

    } else if (exists == "dont") {

        arr = notesGlobal.filter(function(item) {
            return item[1] == ''
        });

    }
    var builtList = buildOrderIDsList(arr);

    $("#orderIDList").html(builtList);
}

function buildNotesList(list) {
    $("#updating").css("display", "block");
    //console.log(list);
    var html = '';
    list = list.sort(function(a, b) {
        return b.timestamp - a.timestamp
    });
    for (var i = 0; i < list.length; i++) {
        html += "<div class='note-line-fixed'>\
              <div class='note-text'>";
        if (list[i].text) {
            var textarr = list[i].text.split('\n');
            for (var j = 0; j < textarr.length; j++) {
                html += "<span>" + textarr[j] + "<br /></span>"

            }

        }

        html += "<div class='note-timestamp2'><span>";
        html += (list[i].selPage || '') + ' - ' + (list[i].user || '');
        html += "</span></div>";
        html += "</div>\
              <div class='note-timestamp'>\
                <span>";
        html += formatDateDisplay2(list[i].timestamp);
        html += "</span>\
              </div>\
            </div>";
    }

    $("#notesContainer").html(html);

    $("#noteTextHolder").css("display", "block");
    $("#updating").css("display", "none");
}

function selectNotesForOrder(event) {

    var orderID = $(event).attr('value');
    selectedNote = orderID;
    var notes = notesGlobal.filter(function(item) {
        return item[0] == orderID
    })[0];
    var list = JSONtoARR(notes[2]);
    buildNotesList(list)

    $("#selectedOrderID").html(orderID);
}

function selectNotesForBatch(orderID) {
    $("#updating").css("display", "block");
    showNotes();
    setTimeout(function() {

        selectedNote = orderID;
        var notes = notesGlobal.filter(function(item) {
            return item[0] == orderID
        })[0];
        var list = JSONtoARR(notes[2]);
        buildNotesList(list)

        $("#selectedOrderID").html(orderID);
        $("#updating").css("display", "none");
        return false;

    }, 10000);

}

function saveNote() {
    var text = $("#noteTextBox").val();

    google.script.run.withSuccessHandler(refreshNotes).saveNote(selectedNote, text, selPage);
}

function refreshNotes(data) {
    var newNote = data[0];
    var msg = data[1];
    var err = data[2];
    alert(msg);
    if (!err) {
        var newNotes = notesGlobal.map(function(item) {
            if (item[0] == selectedNote) {
                item[2] = newNote.notes;
                return item;
            } else {
                return item;
            }

        });
        notesGlobal = newNotes;

        console.log('notes', list)
        var list = JSONtoARR(newNote.notes).sort(function(a, b) {
            return b.timestamp - a.timestamp
        });
        buildNotesList(list)
        $("#noteTextBox").html('')
        $("#noteTextBox").val('')
        $("#selectedOrderID").html(selectedNote);
        getNotesGlobal();

    }
} 
</script>